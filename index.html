<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia - The Dark Chronicles</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00d4ff;
            --neon-purple: #8b5cf6;
            --neon-green: #00ff88;
            --neon-orange: #ff6b35;
            --neon-red: #ff3b3b;
            --dark-bg: #0a0a0f;
            --dark-surface: #1a1a2e;
            --dark-accent: #16213e;
            --glass: rgba(255, 255, 255, 0.05);
            --glow: 0 0 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            backface-visibility: hidden;
        }

        body {
            background: var(--dark-bg);
            font-family: 'Rajdhani', sans-serif;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            position: relative;
        }

        /* Animated Background */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-surface) 50%, var(--dark-accent) 100%);
            z-index: -2;
        }

        .background-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            will-change: transform;
        }

        .stars {
            background: transparent;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            will-change: transform;
        }

        .energy-wave {
            position: absolute;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, transparent 50%, rgba(0, 212, 255, 0.01) 70%, transparent 90%);
            animation: waveRotate 40s linear infinite;
            will-change: transform;
        }

        @keyframes waveRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Menu System */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .screen.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .menu-container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--glow) rgba(0, 212, 255, 0.2);
            max-width: 600px;
            width: 90%;
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 900;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple), var(--neon-green));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
            margin-bottom: 20px;
            text-shadow: var(--glow) var(--neon-blue);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--neon-blue);
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .btn {
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            border: none;
            color: white;
            padding: 15px 30px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 12px;
            margin: 8px;
            min-width: 200px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow) var(--neon-blue);
        }

        .btn:hover::before {
            left: 100%;
        }

        .input-field {
            background: var(--glass);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            color: white;
            padding: 15px 20px;
            font-family: inherit;
            font-size: 1rem;
            text-align: center;
            width: 300px;
            margin: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: var(--neon-blue);
            box-shadow: var(--glow) rgba(0, 212, 255, 0.3);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Story Overlay */
        .story-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 15, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(15px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .story-overlay.active {
            display: flex;
            opacity: 1;
        }

        .story-content {
            max-width: 800px;
            width: 90%;
            text-align: center;
            padding: 40px;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: var(--glow) rgba(0, 212, 255, 0.2);
        }

        .story-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: var(--glow) var(--neon-green);
        }

        .story-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Game Canvas */
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: transparent;
            overflow: hidden;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .hud-panel {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px 20px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            box-shadow: var(--glow) rgba(0, 212, 255, 0.1);
        }

        .control-buttons {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: all;
            z-index: 200;
        }

        .control-btn-top {
            background: var(--glass);
            border: 2px solid var(--neon-orange);
            color: var(--neon-orange);
            padding: 10px 20px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
        }

        .control-btn-top:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow) var(--neon-orange);
        }

        .control-btn-top.home {
            color: var(--neon-orange);
            border-color: var(--neon-orange);
        }

        .control-btn-top.home:hover {
            background: var(--neon-orange);
            color: white;
        }

        .control-btn-top.pause {
            color: var(--neon-red);
            border-color: var(--neon-red);
        }

        .control-btn-top.pause:hover {
            background: var(--neon-red);
            color: white;
        }

        .world {
            position: absolute;
            width: 2000px;
            height: 100vh;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        /* Game Objects */
        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            z-index: 10;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        .player.moving {
            animation: playerPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes playerPulse {
            from { box-shadow: 0 0 15px rgba(0, 212, 255, 0.5); }
            to { box-shadow: 0 0 25px rgba(0, 212, 255, 0.8); }
        }

        .platform {
            position: absolute;
            background: linear-gradient(45deg, var(--neon-purple), var(--dark-surface));
            border-radius: 6px;
            box-shadow: var(--glow) rgba(139, 92, 246, 0.3);
            will-change: transform;
            contain: layout style paint;
        }

        .collectible {
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, var(--neon-green) 0%, var(--neon-blue) 70%);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--neon-green);
            animation: collectibleFloat 2s ease-in-out infinite;
            will-change: transform;
            contain: layout style paint;
        }

        .collectible::before {
            content: '💎';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        @keyframes collectibleFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(180deg); }
        }

        .enemy {
            position: absolute;
            background: linear-gradient(45deg, var(--neon-orange), #ff4444);
            border-radius: 50%;
            box-shadow: var(--glow) var(--neon-orange);
            animation: enemyPulse 1.5s ease-in-out infinite;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        .enemy::before {
            content: '👾';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        @keyframes enemyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .goal {
            position: absolute;
            width: 50px;
            height: 80px;
            background: linear-gradient(0deg, var(--neon-green), var(--neon-blue));
            border-radius: 12px;
            box-shadow: var(--glow) var(--neon-green);
            animation: goalBeacon 2s ease-in-out infinite;
            will-change: transform;
            contain: layout style paint;
        }

        .goal::before {
            content: '🌀';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            animation: goalSpin 3s linear infinite;
        }

        @keyframes goalBeacon {
            0%, 100% { 
                box-shadow: var(--glow) var(--neon-green);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px var(--neon-green), 0 0 60px var(--neon-blue);
                transform: scale(1.05);
            }
        }

        @keyframes goalSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Mobile Controls */
        .mobile-controls {
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
            display: none;
            justify-content: space-between;
            pointer-events: all;
            z-index: 150;
        }

        .control-group {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            background: var(--glass);
            border: 2px solid var(--neon-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: var(--neon-blue);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            backdrop-filter: blur(10px);
        }

        .control-btn:active {
            background: var(--neon-blue);
            color: white;
            transform: scale(0.95);
            box-shadow: var(--glow) var(--neon-blue);
        }

        /* Overlay System */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .overlay.active {
            display: flex;
            opacity: 1;
        }

        .overlay-content {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--glow) rgba(0, 212, 255, 0.2);
        }

        .overlay-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: var(--glow) currentColor;
        }

        .success { color: var(--neon-green); }
        .danger { color: var(--neon-orange); }

        /* Pause Overlay */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(15px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pause-overlay.active {
            display: flex;
            opacity: 1;
        }

        .pause-content {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--glow) rgba(255, 59, 59, 0.2);
        }

        .pause-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 30px;
            color: var(--neon-red);
            text-shadow: var(--glow) var(--neon-red);
        }

        /* Story buttons and countdown */
        .story-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .auto-continue {
            background: var(--glass);
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 1rem;
            margin-top: 20px;
            animation: pulse 2s infinite;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .read-more {
            background: var(--glass);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
        }

        .read-more:hover {
            background: var(--neon-blue);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .mobile-controls { display: flex; }
            .menu-container { padding: 25px; }
            .input-field { width: 250px; }
            .hud { font-size: 0.8rem; padding: 15px; }
            .hud-panel { padding: 10px 15px; }
            .control-btn-top { 
                padding: 8px 15px; 
                font-size: 0.8rem; 
            }
        }

        /* Animation keyframes */
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }
        
        @keyframes messageSlide {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-background">
        <div class="background-layer stars" id="starsLayer"></div>
        <div class="energy-wave"></div>
    </div>

    <!-- Story Overlay -->
    <div id="storyOverlay" class="story-overlay">
        <div class="story-content">
            <div id="storyTitle" class="story-title">LIVELLO 1</div>
            <div id="storyText" class="story-text">Loading story...</div>
            <div class="story-buttons">
                <button id="storyActionBtn" class="btn" onclick="window.gameManager.handleStoryAction()">INIZIA MISSIONE</button>
            </div>
            <div id="readMore" class="read-more" style="display: none;" onclick="window.gameManager.toggleReadMode()">
                📖 Leggi con calma (disattiva countdown)
            </div>
            <div id="autoContinue" class="auto-continue" style="display: none;">
                Prossimo livello tra <span id="countdown">5</span> secondi...
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div id="pauseOverlay" class="pause-overlay">
        <div class="pause-content">
            <div class="pause-title">⏸️ PAUSA</div>
            <p style="margin-bottom: 30px; font-size: 1.1rem; color: rgba(255, 255, 255, 0.8);">
                Il gioco è in pausa. Prenditi una pausa, esploratore!
            </p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn" onclick="window.gameManager.resumeGame()">▶️ RIPRENDI</button>
                <button class="btn" style="background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));" onclick="window.gameManager.goHomeFromPause()">🏠 MENU PRINCIPALE</button>
            </div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="screen active">
        <div class="menu-container">
            <div class="logo">RETROAVIA</div>
            <div class="subtitle">🌌 Esplora le dimensioni digitali perdute 🌌</div>
            
            <div style="margin: 30px 0;">
                <h3 style="color: var(--neon-green); margin-bottom: 15px;">🎯 MISSIONE</h3>
                <p style="margin-bottom: 20px; line-height: 1.6;">
                    Raccogli tutti i cristalli energetici e raggiungi il portale dimensionale. 
                    Evita le entità corrotte e naviga attraverso le dimensioni digitali!
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; text-align: left;">
                    <div>
                        <h4 style="color: var(--neon-blue);">🎮 CONTROLLI</h4>
                        <p style="font-size: 0.9rem;">← → Movimento<br>SPAZIO Salto<br>Evita i nemici!</p>
                    </div>
                    <div>
                        <h4 style="color: var(--neon-purple);">🏆 RICOMPENSE</h4>
                        <p style="font-size: 0.9rem;">Livello 3: Sconto 3%<br>Livello 5: Sconto 5%<br>Gloria eterna!</p>
                    </div>
                </div>
            </div>
            
            <input type="text" id="playerName" class="input-field" placeholder="Il tuo nome da esploratore" maxlength="12">
            <div>
                <button class="btn" onclick="window.gameManager.startGame()">🚀 INIZIA ESPLORAZIONE</button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <div class="game-ui">
                <div class="hud">
                    <div class="hud-panel">
                        <div style="color: var(--neon-blue);">ESPLORATORE: <span id="hud-name">-</span></div>
                        <div style="color: var(--neon-green);">LIVELLO: <span id="hud-level">1</span></div>
                        <div style="color: var(--neon-orange);">ENERGIA: <span id="hud-lives">3</span></div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn-top home" onclick="window.gameManager.goHome()">⌂ HOME</button>
                        <button class="control-btn-top pause" onclick="window.gameManager.pauseGame()">⏸️ PAUSA</button>
                    </div>
                    
                    <div class="hud-panel">
                        <div style="color: var(--neon-purple);">TEMPO: <span id="hud-time">0:00</span></div>
                        <div style="color: var(--neon-blue);">PUNTI: <span id="hud-score">0</span></div>
                        <div style="color: var(--neon-green);">CRISTALLI: <span id="hud-crystals">0/0</span></div>
                    </div>
                </div>
            </div>
            
            <div id="world" class="world"></div>
            
            <!-- Mobile Controls -->
            <div class="mobile-controls">
                <div class="control-group">
                    <div class="control-btn" id="leftBtn">←</div>
                    <div class="control-btn" id="rightBtn">→</div>
                </div>
                <div class="control-group">
                    <div class="control-btn" id="jumpBtn">↑</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Overlay -->
    <div id="gameOverlay" class="overlay">
        <div class="overlay-content">
            <div id="overlayTitle" class="overlay-title">Livello Completato!</div>
            <div id="overlayContent"></div>
            <button id="overlayButton" class="btn" onclick="window.gameManager.nextAction()">CONTINUA</button>
        </div>
    </div>

    <script>
        // Story System Manager
        class StoryManager {
            constructor() {
                this.currentStoryType = null;
                this.countdownTimer = null;
                this.readingMode = false;
                this.stories = {
                    intro1: {
                        title: "🌌 DIMENSIONE ALPHA - IL RISVEGLIO",
                        text: `L'Osservatorio Quantico ha rilevato una catastrofica destabilizzazione nelle dimensioni digitali. Le entità corrotte stanno divorando la realtà stessa.

Tu sei l'ultimo Esploratore Dimensionale rimasto. I cristalli energetici sono la chiave per stabilizzare ogni dimensione prima che collassi nel vuoto.

La tua prima missione: raccogliere tutti i cristalli nella Dimensione Alpha e raggiungere il portale di stabilizzazione. Il tempo è contro di te, esploratore.`,
                        level: 1,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro1: {
                        title: "✨ ALPHA STABILIZZATA",
                        text: `Eccellente lavoro! La Dimensione Alpha è stata stabilizzata. I suoi abitanti digitali possono ora respirare di nuovo.

Ma questo è solo l'inizio. I sensori rilevano anomalie ancora più gravi nelle dimensioni successive. Le entità corrotte stanno imparando dai tuoi movimenti.

Preparati per la Dimensione Beta, dove la gravità sfida le leggi della fisica...`,
                        level: 1,
                        actionText: null
                    },
                    intro2: {
                        title: "🌊 DIMENSIONE BETA - LE ISOLE FLUTTUANTI",
                        text: `Benvenuto nella Dimensione Beta, un reticolo di isole energetiche sospese nel vuoto quantico. Qui la gravità segue regole diverse.

Le piattaforme sono instabili e le entità corrotte hanno sviluppato nuove tattiche. Dovrai saltare con precisione millimetrica per sopravvivere.

I cristalli qui contengono energia pura concentrata. Raccoglili tutti prima che le isole si disgreghino nel caos dimensionale.`,
                        level: 2,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro2: {
                        title: "🏆 BETA PURIFICATA",
                        text: `Le Isole Fluttuanti tornano a brillare! La tua agilità ha impressionato anche gli antichi Guardiani Digitali.

Ma attenzione: i rapporti indicano che la prossima dimensione è controllata da entità corrotte evolute. Preparati alla sfida più dura.

Il Guanto di Sfida ti aspetta, dove ogni passo potrebbe essere l'ultimo...`,
                        level: 2,
                        actionText: null
                    },
                    intro3: {
                        title: "⚔️ DIMENSIONE GAMMA - IL GUANTO DI SFIDA",
                        text: `Hai raggiunto la temuta Dimensione Gamma, conosciuta come "Il Guanto". Qui ogni passo è una trappola, ogni salto una scommessa con la morte.

Le entità corrotte hanno organizzato una difesa coordinata. Ti stanno aspettando.

Completa questa prova e guadagnerai il rispetto dell'intera Confederazione Digitale. I cristalli qui non sono solo energia: sono la chiave per ricompense leggendarie.`,
                        level: 3,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro3: {
                        title: "🎖️ EROE DELLA GAMMA",
                        text: `INCREDIBILE! Hai conquistato il Guanto di Sfida! La Confederazione Digitale ti conferisce il titolo di Eroe Dimensionale.

Come ricompensa per il tuo coraggio, hai sbloccato un codice sconto speciale per il nostro negozio dimensionale.

Ma la guerra non è finita. Le dimensioni finali ti aspettano con sfide che metteranno alla prova ogni fibra del tuo essere.`,
                        level: 3,
                        actionText: null
                    },
                    intro4: {
                        title: "🎯 DIMENSIONE DELTA - PRECISIONE ASSOLUTA",
                        text: `Benvenuto nella Dimensione Delta, dove solo i maestri della precisione possono sopravvivere. Ogni piattaforma è più piccola, ogni salto più pericoloso.

Le entità corrotte qui hanno sviluppato tecniche di caccia perfezionate. Si muovono come ombre, colpiscono come fulmini.

Non c'è spazio per l'errore. Un singolo passo falso significa il ritorno al vuoto quantico. Dimostra di essere degno del titolo di Maestro Esploratore.`,
                        level: 4,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro4: {
                        title: "🏅 MAESTRO DELLA PRECISIONE",
                        text: `La tua precisione è leggendaria! La Dimensione Delta si inchina al tuo passaggio. Gli archivi digitali registreranno per sempre la tua impresa.

Rimane un'ultima sfida. La Dimensione Omega, dove risiede l'Entità Suprema Corrotta. Il destino di tutte le realtà digitali è nelle tue mani.

L'ultima battaglia ti attende nel cuore delle tenebre...`,
                        level: 4,
                        actionText: null
                    },
                    intro5: {
                        title: "💀 DIMENSIONE OMEGA - LO SCONTRO FINALE",
                        text: `Questo è tutto. La Dimensione Omega, cuore della corruzione, regno dell'Entità Suprema. Qui dove tutto è iniziato, tutto deve finire.

Le piattaforme si dissolvono mentre cammini. Le entità corrotte attaccano con furia disperata. E in fondo al livello, TI aspetta.

Fallire qui significa la fine di ogni realtà digitale. Vincere significa diventare una leggenda immortale. Sei pronto, Esploratore Supremo?`,
                        level: 5,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro5: {
                        title: "👑 SALVATORE DELLE DIMENSIONI",
                        text: `L'HAI FATTO! L'Entità Suprema è stata purificata, le dimensioni sono al sicuro, la realtà digitale è salva!

Il tuo nome risuonerà per l'eternità in ogni dimensione. Sei diventato il Salvatore Leggendario, colui che ha riportato l'equilibrio nel multiverso.

Come ricompensa finale, hai sbloccato il codice sconto supremo e la gloria eterna nella storia interdimensionale!`,
                        level: 5,
                        actionText: null
                    }
                };
            }

            showStory(level, type = 'intro') {
                const key = type + level;
                const story = this.stories[key];
                this.currentStoryType = type;
                this.readingMode = false;
                
                if (!story) return;

                document.getElementById('storyTitle').textContent = story.title;
                document.getElementById('storyText').textContent = story.text;
                
                const actionBtn = document.getElementById('storyActionBtn');
                const autoContinue = document.getElementById('autoContinue');
                const readMore = document.getElementById('readMore');
                
                if (story.actionText) {
                    actionBtn.textContent = story.actionText;
                    actionBtn.style.display = 'block';
                    autoContinue.style.display = 'none';
                    readMore.style.display = 'none';
                } else {
                    actionBtn.style.display = 'none';
                    autoContinue.style.display = 'block';
                    readMore.style.display = 'block';
                    this.startAutoCountdown();
                }
                
                document.getElementById('storyOverlay').classList.add('active');
            }

            startAutoCountdown() {
                let seconds = 5;
                const countdownEl = document.getElementById('countdown');
                
                const updateCountdown = () => {
                    if (this.readingMode) return;
                    
                    if (countdownEl) countdownEl.textContent = seconds;
                    
                    if (seconds <= 0) {
                        this.hideStory();
                        if (window.gameManager && window.gameManager.game) {
                            window.gameManager.game.processNextAction();
                        }
                        return;
                    }
                    
                    seconds--;
                    this.countdownTimer = setTimeout(updateCountdown, 1000);
                };
                
                updateCountdown();
            }

            toggleReadingMode() {
                this.readingMode = !this.readingMode;
                const readMore = document.getElementById('readMore');
                const autoContinue = document.getElementById('autoContinue');
                
                if (this.readingMode) {
                    if (this.countdownTimer) {
                        clearTimeout(this.countdownTimer);
                        this.countdownTimer = null;
                    }
                    readMore.textContent = '⏰ Riattiva countdown';
                    readMore.style.borderColor = 'var(--neon-green)';
                    readMore.style.color = 'var(--neon-green)';
                    autoContinue.style.display = 'none';
                    
                    const manualBtn = document.createElement('button');
                    manualBtn.id = 'manualContinueBtn';
                    manualBtn.className = 'btn';
                    manualBtn.textContent = '➡️ CONTINUA';
                    manualBtn.onclick = () => {
                        this.hideStory();
                        if (window.gameManager && window.gameManager.game) {
                            window.gameManager.game.processNextAction();
                        }
                    };
                    readMore.parentNode.appendChild(manualBtn);
                } else {
                    readMore.textContent = '📖 Leggi con calma (disattiva countdown)';
                    readMore.style.borderColor = 'var(--neon-blue)';
                    readMore.style.color = 'var(--neon-blue)';
                    autoContinue.style.display = 'block';
                    
                    const manualBtn = document.getElementById('manualContinueBtn');
                    if (manualBtn) manualBtn.remove();
                    
                    this.startAutoCountdown();
                }
            }

            hideStory() {
                if (this.countdownTimer) {
                    clearTimeout(this.countdownTimer);
                    this.countdownTimer = null;
                }
                document.getElementById('storyOverlay').classList.remove('active');
                
                const manualBtn = document.getElementById('manualContinueBtn');
                if (manualBtn) manualBtn.remove();
            }
        }

        // Game Engine
        class Game {
            constructor() {
                this.state = 'menu';
                this.currentLevel = 1;
                this.maxLevels = 5;
                this.isPaused = false;
                this.player = {
                    x: 50, y: 300, vx: 0, vy: 0,
                    width: 40, height: 40,
                    onGround: false, canJump: true,
                    energy: 3, invulnerable: 0,
                    name: '', coyoteTime: 0
                };
                this.camera = { x: 0, targetX: 0 };
                this.score = 0;
                this.startTime = 0;
                this.gameTime = 0;
                this.keys = {};
                this.entities = [];
                this.running = false;
                this.worldWidth = 1800;
                this.gravity = 0.8;
                this.friction = 0.85;
                
                this.lastRenderTime = 0;
                this.targetFPS = 60;
                this.frameInterval = 1000 / this.targetFPS;
                this.visibleEntities = [];

                this.story = new StoryManager();
                this.setupEventListeners();
                this.setupMobileControls();
                this.initBackground();
            }

            initBackground() {
                this.createStars();
            }

            createStars() {
                const starsLayer = document.getElementById('starsLayer');
                if (!starsLayer) return;
                
                starsLayer.innerHTML = '';
                
                for (let i = 0; i < 25; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.cssText = `
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        width: ${Math.random() * 2 + 1}px;
                        height: ${Math.random() * 2 + 1}px;
                        opacity: ${Math.random() * 0.4 + 0.2};
                    `;
                    starsLayer.appendChild(star);
                }
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    if (this.isPaused) return;
                    this.keys[e.code] = true;
                    if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Space'].includes(e.code)) {
                        e.preventDefault();
                    }
                    
                    if (e.code === 'KeyP' || e.code === 'Escape') {
                        if (this.state === 'playing') {
                            this.pauseGame();
                        }
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });

                const playerNameInput = document.getElementById('playerName');
                if (playerNameInput) {
                    playerNameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            window.gameManager.startGame();
                        }
                    });
                }
            }

            setupMobileControls() {
                const controls = [
                    { id: 'leftBtn', key: 'ArrowLeft' },
                    { id: 'rightBtn', key: 'ArrowRight' },
                    { id: 'jumpBtn', key: 'Space' }
                ];

                controls.forEach(({ id, key }) => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            if (!this.isPaused) this.keys[key] = true;
                        }, { passive: false });
                        btn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            this.keys[key] = false;
                        }, { passive: false });
                        btn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            if (!this.isPaused) this.keys[key] = true;
                        });
                        btn.addEventListener('mouseup', (e) => {
                            e.preventDefault();
                            this.keys[key] = false;
                        });
                    }
                });
            }

            start(playerName) {
                this.player.name = playerName;
                this.currentLevel = 1;
                this.score = 0;
                this.player.energy = 3;
                this.isPaused = false;
                this.startTime = Date.now();
                this.state = 'story';
                this.story.showStory(1, 'intro');
            }

            startLevel() {
                this.loadLevel();
                this.showScreen('gameScreen');
                this.state = 'playing';
                this.isPaused = false;
                this.running = true;
                this.gameLoop();
            }

            pauseGame() {
                if (this.state !== 'playing') return;
                this.isPaused = true;
                this.running = false;
                document.getElementById('pauseOverlay').classList.add('active');
            }

            resumeGame() {
                if (this.state !== 'playing') return;
                this.isPaused = false;
                this.running = true;
                document.getElementById('pauseOverlay').classList.remove('active');
                this.gameLoop();
            }

            goHomeFromPause() {
                this.isPaused = false;
                this.running = false;
                document.getElementById('pauseOverlay').classList.remove('active');
                this.state = 'menu';
                this.showScreen('mainMenu');
            }

            loadLevel() {
                const levels = [
                    // Level 1: Tutorial
                    {
                        platforms: [
                            { x: 0, y: 500, w: 200, h: 20 },
                            { x: 300, y: 450, w: 150, h: 20 },
                            { x: 550, y: 400, w: 150, h: 20 },
                            { x: 800, y: 350, w: 200, h: 20 }
                        ],
                        collectibles: [
                            { x: 350, y: 420 },
                            { x: 600, y: 370 },
                            { x: 850, y: 320 }
                        ],
                        enemies: [
                            { x: 400, y: 420, w: 30, h: 30, vx: 1, range: 100, platformBound: true }
                        ],
                        goal: { x: 950, y: 270 }
                    },
                    // Level 2: Floating Islands
                    {
                        platforms: [
                            { x: 0, y: 520, w: 150, h: 20 },
                            { x: 200, y: 460, w: 120, h: 20 },
                            { x: 380, y: 400, w: 120, h: 20 },
                            { x: 560, y: 340, w: 120, h: 20 },
                            { x: 740, y: 280, w: 120, h: 20 },
                            { x: 920, y: 220, w: 150, h: 20 }
                        ],
                        collectibles: [
                            { x: 240, y: 430 },
                            { x: 420, y: 370 },
                            { x: 600, y: 310 },
                            { x: 780, y: 250 }
                        ],
                        enemies: [
                            { x: 250, y: 430, w: 25, h: 25, vx: -1, range: 80, platformBound: true },
                            { x: 600, y: 310, w: 25, h: 25, vx: 1, range: 80, platformBound: true }
                        ],
                        goal: { x: 990, y: 140 }
                    },
                    // Level 3: The Gauntlet (Reward Level)
                    {
                        platforms: [
                            { x: 0, y: 500, w: 120, h: 20 },
                            { x: 180, y: 450, w: 100, h: 20 },
                            { x: 340, y: 400, w: 100, h: 20 },
                            { x: 500, y: 350, w: 100, h: 20 },
                            { x: 660, y: 300, w: 100, h: 20 },
                            { x: 820, y: 250, w: 100, h: 20 },
                            { x: 980, y: 200, w: 120, h: 20 }
                        ],
                        collectibles: [
                            { x: 220, y: 420 },
                            { x: 380, y: 370 },
                            { x: 540, y: 320 },
                            { x: 700, y: 270 },
                            { x: 860, y: 220 }
                        ],
                        enemies: [
                            { x: 220, y: 420, w: 25, h: 25, vx: -1, range: 60, platformBound: true },
                            { x: 380, y: 370, w: 25, h: 25, vx: 1, range: 60, platformBound: true },
                            { x: 540, y: 320, w: 25, h: 25, vx: -1, range: 60, platformBound: true },
                            { x: 700, y: 270, w: 25, h: 25, vx: 1, range: 60, platformBound: true }
                        ],
                        goal: { x: 1040, y: 120 },
                        reward: "RETRO3"
                    },
                    // Level 4: Precision Platform
                    {
                        platforms: [
                            { x: 0, y: 480, w: 100, h: 20 },
                            { x: 150, y: 430, w: 80, h: 20 },
                            { x: 280, y: 380, w: 80, h: 20 },
                            { x: 410, y: 330, w: 80, h: 20 },
                            { x: 540, y: 280, w: 80, h: 20 },
                            { x: 670, y: 230, w: 80, h: 20 },
                            { x: 800, y: 180, w: 80, h: 20 },
                            { x: 930, y: 130, w: 100, h: 20 }
                        ],
                        collectibles: [
                            { x: 180, y: 400 },
                            { x: 310, y: 350 },
                            { x: 440, y: 300 },
                            { x: 570, y: 250 },
                            { x: 700, y: 200 },
                            { x: 830, y: 150 }
                        ],
                        enemies: [
                            { x: 310, y: 350, w: 25, h: 25, vx: 1, range: 50, platformBound: true },
                            { x: 570, y: 250, w: 25, h: 25, vx: -1, range: 50, platformBound: true },
                            { x: 830, y: 150, w: 25, h: 25, vx: 1, range: 50, platformBound: true }
                        ],
                        goal: { x: 980, y: 50 }
                    },
                    // Level 5: Final Challenge (Reward Level)
                    {
                        platforms: [
                            { x: 0, y: 520, w: 80, h: 20 },
                            { x: 130, y: 480, w: 60, h: 20 },
                            { x: 240, y: 440, w: 60, h: 20 },
                            { x: 350, y: 400, w: 60, h: 20 },
                            { x: 460, y: 360, w: 60, h: 20 },
                            { x: 570, y: 320, w: 60, h: 20 },
                            { x: 680, y: 280, w: 60, h: 20 },
                            { x: 790, y: 240, w: 60, h: 20 },
                            { x: 900, y: 200, w: 60, h: 20 },
                            { x: 1010, y: 160, w: 80, h: 20 }
                        ],
                        collectibles: [
                            { x: 160, y: 450 },
                            { x: 270, y: 410 },
                            { x: 380, y: 370 },
                            { x: 490, y: 330 },
                            { x: 600, y: 290 },
                            { x: 710, y: 250 },
                            { x: 820, y: 210 }
                        ],
                        enemies: [
                            { x: 160, y: 450, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 270, y: 410, w: 25, h: 25, vx: 1, range: 40, platformBound: true },
                            { x: 380, y: 370, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 490, y: 330, w: 25, h: 25, vx: 1, range: 40, platformBound: true },
                            { x: 600, y: 290, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 930, y: 170, w: 35, h: 35, vx: 0, range: 30, platformBound: true }
                        ],
                        goal: { x: 1040, y: 80 },
                        reward: "RETRO5"
                    }
                ];

                const level = levels[this.currentLevel - 1];
                
                this.entities = [];
                this.player.x = 50;
                this.player.y = 400;
                this.player.vx = 0;
                this.player.vy = 0;
                this.player.onGround = false;
                this.player.invulnerable = 0;
                this.camera.x = 0;
                this.camera.targetX = 0;

                level.platforms.forEach(p => {
                    this.entities.push({
                        type: 'platform',
                        x: p.x, y: p.y, w: p.w, h: p.h
                    });
                });

                level.collectibles.forEach(c => {
                    this.entities.push({
                        type: 'collectible',
                        x: c.x, y: c.y, w: 25, h: 25,
                        collected: false
                    });
                });

                level.enemies.forEach((e, index) => {
                    const enemy = {
                        type: 'enemy',
                        id: `enemy_${index}`,
                        x: e.x, y: e.y, w: e.w, h: e.h,
                        vx: e.vx, vy: 0, health: 1,
                        startX: e.x, range: e.range,
                        onGround: false, platformBound: e.platformBound || false,
                        currentPlatform: null
                    };
                    
                    if (enemy.platformBound) {
                        const platform = level.platforms.find(p => 
                            enemy.x >= p.x && enemy.x + enemy.w <= p.x + p.w &&
                            Math.abs(enemy.y + enemy.h - p.y) < 30
                        );
                        if (platform) {
                            enemy.currentPlatform = platform;
                            enemy.y = platform.y - enemy.h;
                        }
                    }
                    
                    this.entities.push(enemy);
                });

                this.entities.push({
                    type: 'goal',
                    x: level.goal.x, y: level.goal.y,
                    w: 50, h: 80
                });

                this.updateHUD();
            }

            gameLoop() {
                if (!this.running || this.isPaused) return;

                const currentTime = performance.now();
                const deltaTime = currentTime - this.lastRenderTime;

                if (deltaTime >= this.frameInterval) {
                    this.update();
                    this.render();
                    this.lastRenderTime = currentTime;
                }

                requestAnimationFrame(() => this.gameLoop());
            }

            update() {
                if (this.isPaused) return;
                
                this.gameTime = Date.now() - this.startTime;
                this.updateTimer();

                this.updatePlayer();
                this.updateEnemies();
                this.updateCamera();
                this.checkCollisions();

                if (this.player.invulnerable > 0) {
                    this.player.invulnerable--;
                }

                if (Date.now() % 2000 < 16) {
                    this.updateBackground();
                }
            }

            updatePlayer() {
                const p = this.player;
                const speed = 7;
                const jumpPower = 17;

                if (this.keys.ArrowLeft) {
                    p.vx = Math.max(p.vx - 1.2, -speed);
                } else if (this.keys.ArrowRight) {
                    p.vx = Math.min(p.vx + 1.2, speed);
                } else {
                    p.vx *= this.friction;
                }

                if (this.keys.Space && (p.onGround || this.player.coyoteTime > 0) && p.canJump) {
                    p.vy = -jumpPower;
                    p.onGround = false;
                    p.canJump = false;
                    this.player.coyoteTime = 0;
                }

                if (!this.keys.Space) {
                    p.canJump = true;
                }

                if (p.onGround) {
                    this.player.coyoteTime = 5;
                } else if (this.player.coyoteTime > 0) {
                    this.player.coyoteTime--;
                }

                p.vy += this.gravity;
                if (p.vy > 15) p.vy = 15;

                if (!this.keys.Space && p.vy < 0) {
                    p.vy *= 0.5;
                }

                p.x += p.vx;
                p.y += p.vy;

                p.onGround = false;
                this.entities.filter(e => e.type === 'platform').forEach(platform => {
                    if (this.collision(p, platform)) {
                        const overlapX = Math.min(p.x + p.width - platform.x, platform.x + platform.w - p.x);
                        const overlapY = Math.min(p.y + p.height - platform.y, platform.y + platform.h - p.y);

                        if (overlapY < overlapX) {
                            if (p.vy > 0 && p.y < platform.y) {
                                p.y = platform.y - p.height;
                                p.vy = 0;
                                p.onGround = true;
                            } else if (p.vy < 0 && p.y > platform.y) {
                                p.y = platform.y + platform.h;
                                p.vy = 0;
                            }
                        } else {
                            if (p.x < platform.x) {
                                p.x = platform.x - p.width;
                            } else {
                                p.x = platform.x + platform.w;
                            }
                            p.vx = 0;
                        }
                    }
                });

                if (p.x < 0) {
                    p.x = 0;
                    p.vx = 0;
                }
                if (p.x + p.width > this.worldWidth) {
                    p.x = this.worldWidth - p.width;
                    p.vx = 0;
                }

                if (p.y > 600) {
                    this.playerDie();
                }
            }

            updateEnemies() {
                const platforms = this.entities.filter(e => e.type === 'platform');
                
                this.entities.filter(e => e.type === 'enemy').forEach((enemy) => {
                    enemy.vy += this.gravity;
                    if (enemy.vy > 10) enemy.vy = 10;
                    
                    if (enemy.platformBound && enemy.currentPlatform) {
                        const platform = enemy.currentPlatform;
                        
                        const nextX = enemy.x + enemy.vx * 2;
                        const wouldFallOff = (nextX <= platform.x) || (nextX + enemy.w >= platform.x + platform.w);
                        
                        const atRangeLimit = Math.abs(enemy.x - enemy.startX) >= enemy.range;
                        
                        if (wouldFallOff || atRangeLimit) {
                            enemy.vx *= -1;
                        }
                        
                        enemy.x = Math.max(platform.x, Math.min(platform.x + platform.w - enemy.w, enemy.x + enemy.vx));
                        enemy.y = platform.y - enemy.h;
                        enemy.vy = 0;
                        enemy.onGround = true;
                    } else {
                        enemy.x += enemy.vx;
                        enemy.y += enemy.vy;
                        
                        enemy.onGround = false;
                        platforms.forEach(platform => {
                            if (this.collision(enemy, platform)) {
                                if (enemy.vy > 0 && enemy.y < platform.y) {
                                    enemy.y = platform.y - enemy.h;
                                    enemy.vy = 0;
                                    enemy.onGround = true;
                                    if (enemy.platformBound) {
                                        enemy.currentPlatform = platform;
                                    }
                                }
                            }
                        });
                        
                        if (enemy.x < 0 || enemy.x + enemy.w > this.worldWidth) {
                            enemy.vx *= -1;
                        }
                        
                        if (enemy.y > 700) {
                            enemy.x = enemy.startX;
                            enemy.y = enemy.startX - 100;
                            enemy.vy = 0;
                            enemy.vx = Math.abs(enemy.vx) * (Math.random() > 0.5 ? 1 : -1);
                        }
                    }
                });
            }

            updateCamera() {
                const target = Math.max(0, Math.min(this.player.x - 400, this.worldWidth - 800));
                this.camera.targetX = target;
                this.camera.x += (this.camera.targetX - this.camera.x) * 0.12;
            }

            updateBackground() {
                const starsLayer = document.getElementById('starsLayer');
                
                if (starsLayer) {
                    const transform = `translate3d(${-this.camera.x * 0.08}px, 0, 0)`;
                    starsLayer.style.transform = transform;
                }
            }

            checkCollisions() {
                const p = this.player;

                const nearbyEntities = this.entities.filter(entity => 
                    Math.abs(entity.x - p.x) < 100 && Math.abs(entity.y - p.y) < 100
                );

                nearbyEntities.forEach((entity, i) => {
                    if (!this.collision(p, entity)) return;

                    switch (entity.type) {
                        case 'collectible':
                            if (!entity.collected) {
                                entity.collected = true;
                                this.score += 100;
                                this.updateHUD();
                                this.showCollectEffect(entity.x, entity.y);
                            }
                            break;

                        case 'enemy':
                            if (this.player.invulnerable === 0) {
                                this.playerDie();
                            }
                            break;

                        case 'goal':
                            const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                            const total = this.entities.filter(e => e.type === 'collectible').length;
                            
                            if (collected === total) {
                                this.levelComplete();
                            } else {
                                this.showMessage(`Raccogli tutti i cristalli! (${collected}/${total})`);
                            }
                            break;
                    }
                });
            }

            showCollectEffect(x, y) {
                const effect = document.createElement('div');
                effect.style.cssText = `
                    position: absolute;
                    left: ${x - this.camera.x}px;
                    top: ${y}px;
                    width: 30px;
                    height: 30px;
                    background: radial-gradient(circle, var(--neon-green), transparent);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    animation: collectEffect 0.5s ease-out forwards;
                `;
                
                if (!document.getElementById('collectEffectStyle')) {
                    const style = document.createElement('style');
                    style.id = 'collectEffectStyle';
                    style.textContent = `
                        @keyframes collectEffect {
                            0% { transform: scale(0.5); opacity: 1; }
                            100% { transform: scale(2); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(effect);
                setTimeout(() => effect.remove(), 500);
            }

            collision(a, b) {
                return a.x < b.x + b.w && 
                       a.x + a.width > b.x && 
                       a.y < b.y + b.h && 
                       a.y + a.height > b.y;
            }

            playerDie() {
                this.player.energy--;
                
                if (this.player.energy <= 0) {
                    this.gameOver();
                } else {
                    this.player.x = 50;
                    this.player.y = 400;
                    this.player.vx = 0;
                    this.player.vy = 0;
                    this.player.invulnerable = 120;
                    this.camera.x = 0;
                    this.camera.targetX = 0;
                    this.updateHUD();
                    this.showMessage(`💔 Energia rimasta: ${this.player.energy}`);
                }
            }

            levelComplete() {
                this.running = false;
                this.score += 1000 + (this.player.energy * 300);
                this.story.showStory(this.currentLevel, 'outro');
            }

            processNextAction() {
                if (this.currentLevel === 3 || this.currentLevel === 5) {
                    this.showReward();
                } else if (this.currentLevel < this.maxLevels) {
                    this.nextLevel();
                } else {
                    this.showGameComplete();
                }
            }

            showReward() {
                const rewardCode = this.generateRewardCode();
                const discount = this.currentLevel === 3 ? '3%' : '5%';
                const minimum = this.currentLevel === 3 ? '150€' : '180€';

                document.getElementById('overlayTitle').textContent = '🎉 RICOMPENSA SBLOCCATA!';
                document.getElementById('overlayTitle').className = 'overlay-title success';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="background: linear-gradient(45deg, var(--neon-green), var(--neon-blue)); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; font-family: 'Orbitron', monospace; font-size: 1.2rem; font-weight: 700;">
                        ${rewardCode}
                    </div>
                    <p style="font-size: 1.1rem; color: var(--neon-green); margin: 15px 0;">
                        <strong>✨ Sconto ${discount} su ordini sopra ${minimum} ✨</strong>
                    </p>
                    <p style="font-size: 0.9rem; opacity: 0.8;">
                        🔒 Salva questo codice! Verrà accettato nel nostro store.
                    </p>
                    <p style="margin-top: 20px; color: var(--neon-blue);">
                        Punteggio: <strong>${this.score.toLocaleString()}</strong>
                    </p>
                `;
                
                document.getElementById('overlayButton').textContent = this.currentLevel < this.maxLevels ? '➡️ CONTINUA' : '🏠 TORNA AL MENU';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    if (this.currentLevel < this.maxLevels) {
                        this.nextLevel();
                    } else {
                        this.showGameComplete();
                    }
                };
                
                this.showOverlay();
            }

            showGameComplete() {
                document.getElementById('overlayTitle').textContent = '👑 MISSIONE COMPLETATA!';
                document.getElementById('overlayTitle').className = 'overlay-title success';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <h2 style="color: var(--neon-green); font-size: 1.5rem; margin-bottom: 20px;">
                            🎉 HAI SALVATO TUTTE LE DIMENSIONI! 🎉
                        </h2>
                        
                        <div style="background: var(--glass); border-radius: 15px; padding: 25px; margin: 20px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                                <div><strong style="color: var(--neon-blue);">🏆 Esploratore:</strong><br>${this.player.name}</div>
                                <div><strong style="color: var(--neon-blue);">⏱️ Tempo:</strong><br>${this.formatTime(this.gameTime)}</div>
                                <div><strong style="color: var(--neon-blue);">💯 Punteggio:</strong><br>${this.score.toLocaleString()}</div>
                                <div><strong style="color: var(--neon-blue);">⚡ Energia finale:</strong><br>${this.player.energy}/3</div>
                            </div>
                        </div>
                        
                        <p style="font-size: 1rem; color: var(--neon-green); margin: 15px 0;">
                            🌌 Tutte le dimensioni digitali sono state ripristinate!<br>
                            🎮 Sei ufficialmente un Maestro Esploratore!
                        </p>
                    </div>
                `;
                
                document.getElementById('overlayButton').textContent = '🏠 TORNA AL MENU';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    this.showScreen('mainMenu');
                };
                
                this.showOverlay();
            }

            gameOver() {
                this.running = false;
                
                document.getElementById('overlayTitle').textContent = '💀 MISSIONE FALLITA';
                document.getElementById('overlayTitle').className = 'overlay-title danger';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <p style="font-size: 1.1rem; color: var(--neon-orange); margin-bottom: 20px;">
                            ⚡ Le entità corrotte hanno vinto... per ora ⚡
                        </p>
                        
                        <div style="background: var(--glass); border-radius: 10px; padding: 20px; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>🎯 Livello raggiunto:</span>
                                <span style="color: var(--neon-blue);">${this.currentLevel}/${this.maxLevels}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>💯 Punteggio finale:</span>
                                <span style="color: var(--neon-green);">${this.score.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>⏱️ Tempo sopravvissuto:</span>
                                <span style="color: var(--neon-purple);">${this.formatTime(this.gameTime)}</span>
                            </div>
                        </div>
                        
                        <p style="font-size: 1rem; margin: 15px 0; color: var(--neon-blue);">
                            💪 Non mollare! Le dimensioni hanno ancora bisogno di te!
                        </p>
                    </div>
                `;
                
                document.getElementById('overlayButton').textContent = '🔄 RIPROVA';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    this.currentLevel = 1;
                    this.score = 0;
                    this.player.energy = 3;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.story.showStory(1, 'intro');
                };
                
                this.showOverlay();
            }

            nextLevel() {
                this.currentLevel++;
                if (this.currentLevel <= this.maxLevels) {
                    this.story.showStory(this.currentLevel, 'intro');
                }
            }

            confirmExit() {
                if (confirm('Vuoi davvero tornare al menu? Il progresso andrà perso.')) {
                    this.running = false;
                    this.isPaused = false;
                    this.state = 'menu';
                    this.showScreen('mainMenu');
                }
            }

            generateRewardCode() {
                const prefix = this.currentLevel === 3 ? 'RETRO3' : 'RETRO5';
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.random().toString(36).substr(2, 4).toUpperCase();
                const playerHash = this.player.name.slice(0, 2).toUpperCase();
                return `${prefix}-${playerHash}${timestamp.slice(-3)}-${random}`;
            }

            render() {
                const world = document.getElementById('world');
                if (!world) return;
                
                world.style.transform = `translate3d(${-this.camera.x}px, 0, 0)`;
                world.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                
                const playerEl = document.createElement('div');
                playerEl.className = 'player';
                playerEl.style.cssText = `
                    left: ${this.player.x}px;
                    top: ${this.player.y}px;
                `;
                
                if (Math.abs(this.player.vx) > 1) {
                    playerEl.classList.add('moving');
                }
                
                if (this.player.invulnerable > 0) {
                    playerEl.style.opacity = Math.sin(this.player.invulnerable * 0.3) * 0.5 + 0.5;
                }
                
                fragment.appendChild(playerEl);
                
                const cameraLeft = this.camera.x - 150;
                const cameraRight = this.camera.x + 950;
                
                this.visibleEntities = this.entities.filter(entity => {
                    if (entity.type === 'collectible' && entity.collected) return false;
                    return entity.x + entity.w >= cameraLeft && entity.x <= cameraRight;
                });
                
                this.visibleEntities.forEach(entity => {
                    const el = document.createElement('div');
                    el.className = entity.type;
                    
                    if (entity.id) {
                        el.setAttribute('data-enemy-id', entity.id);
                    }
                    
                    el.style.cssText = `
                        left: ${entity.x}px;
                        top: ${entity.y}px;
                        width: ${entity.w}px;
                        height: ${entity.h}px;
                    `;
                    
                    if (entity.type === 'enemy' && entity.w > 30) {
                        el.style.background = 'linear-gradient(45deg, var(--neon-purple), var(--neon-orange))';
                        el.style.border = '2px solid var(--neon-purple)';
                        el.style.boxShadow = '0 0 30px var(--neon-purple)';
                    }
                    
                    fragment.appendChild(el);
                });
                
                world.appendChild(fragment);
            }

            updateHUD() {
                const updates = {
                    'hud-name': this.player.name,
                    'hud-level': this.currentLevel,
                    'hud-lives': this.player.energy,
                    'hud-score': this.score.toLocaleString()
                };
                
                Object.entries(updates).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && el.textContent !== value) {
                        el.textContent = value;
                    }
                });
                
                const hudCrystals = document.getElementById('hud-crystals');
                if (hudCrystals) {
                    const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                    const total = this.entities.filter(e => e.type === 'collectible').length;
                    const crystalText = `${collected}/${total}`;
                    if (hudCrystals.textContent !== crystalText) {
                        hudCrystals.textContent = crystalText;
                    }
                }
            }

            updateTimer() {
                const time = this.formatTime(this.gameTime);
                const hudTime = document.getElementById('hud-time');
                if (hudTime && hudTime.textContent !== time) {
                    hudTime.textContent = time;
                }
            }

            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                setTimeout(() => {
                    const screen = document.getElementById(screenId);
                    if (screen) screen.classList.add('active');
                }, 100);
                this.state = screenId === 'mainMenu' ? 'menu' : this.state;
            }

            showOverlay() {
                const overlay = document.getElementById('gameOverlay');
                if (overlay) overlay.classList.add('active');
            }

            hideOverlay() {
                const overlay = document.getElementById('gameOverlay');
                if (overlay) overlay.classList.remove('active');
            }

            showMessage(text) {
                const message = document.createElement('div');
                message.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--glass);
                    backdrop-filter: blur(10px);
                    border: 2px solid var(--neon-orange);
                    color: var(--neon-orange);
                    padding: 15px 25px;
                    border-radius: 10px;
                    font-family: 'Orbitron', monospace;
                    font-weight: 700;
                    z-index: 500;
                    animation: messageSlide 0.3s ease;
                `;
                message.textContent = text;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.style.animation = 'messageSlide 0.3s ease reverse';
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.remove();
                        }
                    }, 300);
                }, 2000);
            }
        }

        // Game Manager - Central hub for all game interactions
        class GameManager {
            constructor() {
                this.game = null;
                this.init();
            }

            init() {
                this.game = new Game();
                
                // Prevent context menu on long press (mobile)
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                // Prevent zoom on double tap (mobile)
                let lastTouchEnd = 0;
                document.addEventListener('touchend', e => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // Enhanced page visibility handling
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.game && this.game.running) {
                        this.game.pauseGame();
                        this.game.showMessage('🔄 Gioco automaticamente in pausa');
                    }
                });
                
                // Prevent accidental page refresh during gameplay
                window.addEventListener('beforeunload', e => {
                    if (this.game && this.game.running && this.game.state === 'playing') {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
                
                console.log('🎮 RetroAvia - The Dark Chronicles caricato con successo!');
            }

            // Global function handlers
            startGame() {
                const nameInput = document.getElementById('playerName');
                if (!nameInput) return;
                
                const name = nameInput.value.trim();
                if (!name || name.length < 2) {
                    this.showNotification('Inserisci un nome di almeno 2 caratteri!');
                    return;
                }
                if (name.length > 12) {
                    this.showNotification('Il nome deve essere massimo 12 caratteri!');
                    return;
                }
                
                if (this.game) {
                    this.game.start(name);
                }
            }

            handleStoryAction() {
                if (this.game && this.game.story) {
                    this.game.story.hideStory();
                    if (this.game.story.currentStoryType === 'intro') {
                        this.game.startLevel();
                    } else {
                        this.game.processNextAction();
                    }
                }
            }

            toggleReadMode() {
                if (this.game && this.game.story) {
                    this.game.story.toggleReadingMode();
                }
            }

            pauseGame() {
                if (this.game) {
                    this.game.pauseGame();
                }
            }

            resumeGame() {
                if (this.game) {
                    this.game.resumeGame();
                }
            }

            goHomeFromPause() {
                if (this.game) {
                    this.game.goHomeFromPause();
                }
            }

            showMenu() {
                if (this.game) {
                    this.game.running = false;
                    this.game.isPaused = false;
                    this.game.state = 'menu';
                    this.game.showScreen('mainMenu');
                }
            }

            goHome() {
                if (this.game && this.game.state === 'playing') {
                    this.game.confirmExit();
                } else if (this.game) {
                    this.showMenu();
                }
            }

            nextAction() {
                // This function is dynamically set by overlay functions
                const overlayButton = document.getElementById('overlayButton');
                if (overlayButton && overlayButton.onclick) {
                    overlayButton.onclick();
                }
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--neon-orange);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    font-family: 'Orbitron', monospace;
                    font-weight: 700;
                    z-index: 2000;
                    animation: slideDown 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            try {
                window.gameManager = new GameManager();
            } catch (error) {
                console.error('Errore inizializzazione gioco:', error);
                alert('Errore caricamento gioco. Ricarica la pagina.');
            }
        });
    </script>
</body>
</html>
