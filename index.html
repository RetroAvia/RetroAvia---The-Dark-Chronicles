<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>RetroAvia - The Dark Chronicles</title>
    <style>
        /* Font Imports - Embedded per evitare errori CORS */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap');
        
        /* Fallback fonts nel caso i Google Fonts non si carichino */
        @font-face {
            font-family: 'Orbitron-Fallback';
            src: local('Courier New'), local('monospace');
            font-weight: 400 900;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Rajdhani-Fallback';
            src: local('Arial'), local('Helvetica'), local('sans-serif');
            font-weight: 300 600;
            font-display: swap;
        }
        
        :root {
            --neon-blue: #00d4ff;
            --neon-purple: #8b5cf6;
            --neon-green: #00ff88;
            --neon-orange: #ff6b35;
            --neon-red: #ff3b3b;
            --neon-cyan: #00ffff;
            --neon-pink: #ff0080;
            --dark-bg: #0a0a0f;
            --dark-surface: #1a1a2e;
            --dark-accent: #16213e;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glow: 0 0 20px;
            --shadow-deep: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            backface-visibility: hidden;
        }

        body {
            background: var(--dark-bg);
            font-family: 'Rajdhani', 'Rajdhani-Fallback', Arial, sans-serif;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            position: relative;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* NASCONDI COMPLETAMENTE TUTTO IL CODICE VISIBILE */
        .screen:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .story-overlay:not(.active),
        .pause-overlay:not(.active),
        .overlay:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Nascondi elementi del gioco quando non in game */
        body:not(.game-active) .game-ui,
        body:not(.game-active) .world,
        body:not(.game-active) .mobile-controls {
            display: none !important;
            visibility: hidden !important;
        }

        /* RESPONSIVE DESIGN MIGLIORATO - Mobile First */
        @media screen and (max-width: 768px) {
            /* Fix per scroll nel menu principale */
            body:not(.game-active) {
                overflow-y: auto;
                overflow-x: hidden;
                height: auto;
                min-height: 100vh;
            }
            
            /* Gioco sempre fullscreen */
            body.game-active {
                overflow: hidden;
                height: 100vh;
            }
            
            .game-container {
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                position: relative;
            }
            
            /* Fix viewport per mobile game */
            .world {
                width: 120vw; /* Ridotto ulteriormente per mobile */
                height: 100vh;
                transform-origin: left top;
            }
            
            /* Zoom controls per mobile */
            .mobile-zoom-controls {
                position: absolute;
                top: 80px;
                right: 10px;
                display: flex;
                flex-direction: column;
                gap: 5px;
                z-index: 200;
                pointer-events: all;
            }
            
            .zoom-btn {
                background: var(--glass);
                border: 2px solid var(--neon-blue);
                color: var(--neon-blue);
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            }
            
            .zoom-btn:active {
                background: var(--neon-blue);
                color: white;
                transform: scale(0.95);
            }
            
            .mobile-controls { 
                display: flex; 
                bottom: 15px;
                left: 15px;
                right: 15px;
                /* Controlli più grandi per touch */
                gap: 20px;
            }
            
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 1.4rem;
                /* Miglior feedback tattile */
                border: 3px solid var(--neon-blue);
            }
            
            /* HUD più compatto per mobile */
            .futuristic-hud {
                height: 60px;
                padding: 5px 10px;
            }
            
            .hud-layout { 
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 8px;
                padding: 8px 15px;
            }
            
            .player-panel {
                grid-column: 1 / -1;
                grid-row: 1;
                padding: 6px 10px;
            }
            
            .game-dashboard {
                grid-column: 1;
                grid-row: 2;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .control-cluster {
                grid-column: 2;
                grid-row: 2;
                align-self: center;
                gap: 5px;
            }
            
            .energy-system {
                grid-column: 1 / -1;
                grid-row: 3;
                padding: 6px 10px;
                margin-top: 5px;
            }

            /* Menu mobile ottimizzato */
            .mission-cards {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .mission-card {
                padding: 15px;
            }
            
            .retro-logo .retro-text {
                font-size: clamp(2rem, 8vw, 3.5rem);
            }
            
            .dark-chronicles {
                font-size: clamp(0.8rem, 3vw, 1rem);
                letter-spacing: 1.5px;
            }
            
            .briefing-intro {
                font-size: 0.9rem;
                padding: 0 10px;
                line-height: 1.5;
            }
            
            .futuristic-input {
                font-size: 0.9rem;
                padding: 10px 15px;
                max-width: 300px;
            }
            
            .launch-button {
                font-size: 0.9rem;
                padding: 10px 25px;
                min-width: 200px;
            }

            .story-content {
                padding: 20px 15px;
                width: 95%;
                margin: 10px;
            }

            .story-title {
                font-size: 1.4rem;
            }

            .story-text {
                font-size: 0.85rem;
                line-height: 1.4;
            }
        }

        /* Adaptive Quality - Riduce effetti su device lenti */
        @media (max-width: 480px), (max-height: 600px) {
            .energy-wave {
                animation: none;
            }
            
            .background-layer {
                opacity: 0.1;
            }
            
            * {
                will-change: auto;
            }
            
            .collectible {
                animation-duration: 4s;
            }
            
            .enemy {
                animation-duration: 3s;
            }
        }

        /* Animated Background */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-surface) 50%, var(--dark-accent) 100%);
            z-index: -2;
        }

        .background-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            will-change: transform;
        }

        .stars {
            background: transparent;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            will-change: transform;
        }

        .energy-wave {
            position: absolute;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, transparent 50%, rgba(0, 212, 255, 0.01) 70%, transparent 90%);
            animation: waveRotate 40s linear infinite;
            will-change: transform;
        }

        @keyframes waveRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Menu System */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        /* MENU PRINCIPALE OTTIMIZZATO */
        .main-menu-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(
                135deg,
                rgba(10, 10, 15, 0.95) 0%,
                rgba(26, 26, 46, 0.9) 30%,
                rgba(139, 92, 246, 0.1) 60%,
                rgba(0, 212, 255, 0.05) 100%
            );
            backdrop-filter: blur(15px);
        }

        .main-menu-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Ccircle cx='30' cy='30' r='1'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            animation: matrixRain 20s linear infinite;
            z-index: -1;
        }

        @keyframes matrixRain {
            0% { transform: translateY(-60px); }
            100% { transform: translateY(60px); }
        }

        /* Logo compatto */
        .retro-logo {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 900;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }

        .retro-logo .retro-text {
            background: linear-gradient(
                45deg,
                var(--neon-blue) 0%,
                var(--neon-cyan) 25%,
                var(--neon-purple) 50%,
                var(--neon-pink) 75%,
                var(--neon-green) 100%
            );
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: logoGradient 4s ease-in-out infinite;
            text-shadow: 
                0 0 30px rgba(0, 212, 255, 0.5),
                0 0 60px rgba(139, 92, 246, 0.3),
                0 0 90px rgba(0, 255, 136, 0.2);
        }

        .dark-chronicles {
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            color: var(--neon-orange);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--neon-orange);
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes logoGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes titlePulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        /* Mission briefing compatto */
        .mission-briefing {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .briefing-intro {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 25px;
            animation: fadeInUp 1s ease-out 0.5s both;
        }

        .mission-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .mission-card {
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 1s ease-out both;
        }

        .mission-card:nth-child(1) { animation-delay: 0.7s; }
        .mission-card:nth-child(2) { animation-delay: 0.9s; }
        .mission-card:nth-child(3) { animation-delay: 1.1s; }

        .mission-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-blue);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(0, 212, 255, 0.2);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .card-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--neon-blue);
        }

        .card-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .objective-card { color: var(--neon-green); }
        .controls-card { color: var(--neon-cyan); }
        .rewards-card { color: var(--neon-purple); }

        /* Input section compatto */
        .player-input-section {
            margin-top: 25px;
            text-align: center;
        }

        .input-label {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: var(--neon-blue);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeInUp 1s ease-out 1.3s both;
        }

        .futuristic-input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            color: white;
            padding: 12px 20px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 100%;
            max-width: 350px;
            margin: 0 auto 15px;
            outline: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            animation: fadeInUp 1s ease-out 1.5s both;
        }

        .futuristic-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 
                0 0 20px rgba(0, 212, 255, 0.3),
                inset 0 0 15px rgba(0, 212, 255, 0.1);
            transform: scale(1.02);
        }

        .futuristic-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .launch-button {
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            border: none;
            color: white;
            padding: 12px 30px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 12px;
            min-width: 220px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeInUp 1s ease-out 1.7s both;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(0, 255, 136, 0.3);
        }

        .launch-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .launch-button:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(0, 255, 136, 0.5);
        }

        .launch-button:hover::before {
            left: 100%;
        }

        .launch-button:active {
            transform: translateY(-1px) scale(1.01);
            transition: transform 0.1s ease;
        }

        /* Enhanced Message System */
        .enhanced-message {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, 
                rgba(255, 107, 53, 0.95), 
                rgba(255, 59, 59, 0.95));
            backdrop-filter: blur(15px);
            border: 2px solid var(--neon-orange);
            border-radius: 12px;
            color: white;
            padding: 15px 25px;
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 600;
            animation: enhancedMessageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 107, 53, 0.4);
            max-width: 350px;
            text-align: center;
        }

        .enhanced-message::before {
            content: '⚠️';
            font-size: 1.2rem;
            margin-right: 8px;
        }

        @keyframes enhancedMessageSlide {
            from { 
                transform: translateX(-50%) translateY(-20px); 
                opacity: 0; 
                scale: 0.9;
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
                scale: 1;
            }
        }

        .btn {
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            border: none;
            color: white;
            padding: 12px 25px;
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            margin: 6px;
            min-width: 180px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow) var(--neon-blue);
        }

        .btn:hover::before {
            left: 100%;
        }

        /* Story Overlay */
        .story-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 15, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(15px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .story-overlay.active {
            display: flex;
            opacity: 1;
        }

        .story-content {
            max-width: 700px;
            width: 90%;
            text-align: center;
            padding: 30px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: var(--shadow-deep), var(--glow) rgba(0, 212, 255, 0.2);
        }

        .story-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: var(--glow) var(--neon-green);
        }

        .story-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Game Canvas */
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: transparent;
            overflow: hidden;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .world {
            position: absolute;
            width: 2000px;
            height: 100vh;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        /* HUD OTTIMIZZATO */
        .futuristic-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, 
                rgba(10, 10, 15, 0.95) 0%, 
                rgba(26, 26, 46, 0.85) 70%, 
                rgba(26, 26, 46, 0.3) 90%,
                transparent 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            pointer-events: none;
            z-index: 150;
            overflow: hidden;
        }

        .futuristic-hud::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 255, 255, 0.03) 25%, 
                rgba(139, 92, 246, 0.05) 50%, 
                rgba(0, 255, 136, 0.03) 75%, 
                transparent 100%);
            animation: hologramScan 4s linear infinite;
        }

        @keyframes hologramScan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        .hud-layout {
            display: grid;
            grid-template-columns: 220px 1fr auto auto auto 220px;
            gap: 12px;
            padding: 10px 20px;
            height: 100%;
            align-items: center;
        }

        /* Player panel compatto */
        .player-panel {
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.15) 0%, 
                rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 8px 12px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
        }

        .player-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--neon-blue) 30%, 
                var(--neon-purple) 70%, 
                transparent 100%);
            animation: energyFlow 3s ease-in-out infinite;
        }

        @keyframes energyFlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .player-avatar::before {
            content: '🚀';
            z-index: 2;
            position: relative;
        }

        .player-details {
            flex: 1;
        }

        .player-name {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--neon-blue);
            text-shadow: 0 0 6px var(--neon-blue);
            margin-bottom: 2px;
        }

        .player-level {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-badge {
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-pink));
            color: white;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 6px;
        }

        /* Dashboard centrale ottimizzato */
        .game-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            justify-content: center;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 6px 10px;
            text-align: center;
            min-width: 70px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0.5;
        }

        .metric-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1px;
        }

        .metric-value {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 0 0 4px currentColor;
        }

        .score-card { color: var(--neon-green); }
        .time-card { color: var(--neon-cyan); }
        .crystals-card { color: var(--neon-purple); }

        /* Energy System compatto */
        .energy-system {
            background: linear-gradient(135deg, 
                rgba(255, 107, 53, 0.15) 0%, 
                rgba(255, 59, 59, 0.1) 100%);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(15px);
            position: relative;
        }

        .energy-system::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--neon-orange) 30%, 
                var(--neon-red) 70%, 
                transparent 100%);
            animation: energyFlow 2s ease-in-out infinite reverse;
        }

        .energy-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }

        .energy-icon::before {
            content: '⚡';
        }

        .energy-display {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .energy-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .energy-bar {
            display: flex;
            gap: 3px;
        }

        .energy-orb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));
            box-shadow: 0 0 8px var(--neon-orange);
            position: relative;
            overflow: hidden;
        }

        .energy-orb::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: orbPulse 1.5s ease-in-out infinite;
        }

        .energy-orb.empty {
            background: linear-gradient(45deg, 
                rgba(255, 107, 53, 0.2), 
                rgba(255, 59, 59, 0.2));
            box-shadow: 0 0 4px rgba(255, 107, 53, 0.2);
        }

        .energy-orb.empty::before {
            display: none;
        }

        @keyframes orbPulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Control Buttons ottimizzati */
        .control-cluster {
            display: flex;
            gap: 6px;
            pointer-events: all;
        }

        .neo-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid;
            color: white;
            padding: 8px 10px;
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
            min-width: 38px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .neo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.4s ease;
        }

        .neo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .neo-btn:hover::before {
            left: 100%;
        }

        .neo-btn:active {
            transform: translateY(0);
            transition: transform 0.1s ease;
        }

        .home-btn {
            color: var(--neon-orange);
            border-color: var(--neon-orange);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.2);
        }

        .home-btn:hover {
            background: var(--neon-orange);
            color: var(--dark-bg);
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
        }

        .pause-btn {
            color: var(--neon-red);
            border-color: var(--neon-red);
            box-shadow: 0 0 10px rgba(255, 59, 59, 0.2);
        }

        .pause-btn:hover {
            background: var(--neon-red);
            color: white;
            box-shadow: 0 4px 20px rgba(255, 59, 59, 0.4);
        }

        .restart-btn {
            color: var(--neon-green);
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .restart-btn:hover {
            background: var(--neon-green);
            color: var(--dark-bg);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
        }

        /* Mobile Controls */
        .mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            pointer-events: all;
            z-index: 150;
        }

        .control-group {
            display: flex;
            gap: 12px;
        }

        .control-btn {
            background: var(--glass);
            border: 2px solid var(--neon-blue);
            border-radius: 50%;
            width: 55px;
            height: 55px;
            color: var(--neon-blue);
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            backdrop-filter: blur(10px);
        }

        .control-btn:active {
            background: var(--neon-blue);
            color: white;
            transform: scale(0.95);
            box-shadow: var(--glow) var(--neon-blue);
        }

        /* Controlli TTS e Qualità */
        .audio-controls {
            position: absolute;
            bottom: 15px;
            left: 15px;
            pointer-events: all;
            z-index: 200;
            display: flex;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .audio-controls {
                bottom: 90px;
                left: 10px;
                flex-direction: column;
                gap: 6px;
            }
        }

        .audio-btn, .quality-btn {
            background: var(--glass);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 6px 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            min-width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-btn:hover, .quality-btn:hover {
            background: var(--neon-blue);
            color: white;
        }

        .audio-btn.muted {
            color: var(--neon-red);
            border-color: var(--neon-red);
        }

        .quality-btn.low-quality {
            color: var(--neon-orange);
            border-color: var(--neon-orange);
        }

        /* Game Objects */
        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            z-index: 10;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
            transition: none;
        }

        .player.moving {
            animation: playerPulse 0.5s ease-in-out infinite alternate;
        }

        .player.invulnerable {
            animation: playerFlash 0.2s ease-in-out infinite;
        }

        .player.respawning {
            pointer-events: none;
            animation: respawnFlash 0.15s ease-in-out infinite;
        }

        /* NUOVA ANIMAZIONE DEATH */
        .player.dying {
            animation: playerDeath 0.8s ease-out forwards;
            z-index: 50;
        }

        @keyframes playerDeath {
            0% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
                box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            }
            25% { 
                transform: scale(1.2) rotate(90deg);
                opacity: 0.8;
                box-shadow: 0 0 30px rgba(255, 59, 59, 0.8);
            }
            50% { 
                transform: scale(0.8) rotate(180deg);
                opacity: 0.6;
                box-shadow: 0 0 40px rgba(255, 59, 59, 1);
            }
            75% { 
                transform: scale(0.4) rotate(270deg);
                opacity: 0.3;
                box-shadow: 0 0 20px rgba(255, 59, 59, 0.5);
            }
            100% { 
                transform: scale(0) rotate(360deg);
                opacity: 0;
                box-shadow: 0 0 5px rgba(255, 59, 59, 0.2);
            }
        }

        @keyframes playerPulse {
            from { box-shadow: 0 0 15px rgba(0, 212, 255, 0.5); }
            to { box-shadow: 0 0 25px rgba(0, 212, 255, 0.8); }
        }

        @keyframes playerFlash {
            0%, 60% { opacity: 1; }
            61%, 100% { opacity: 0.2; }
        }

        @keyframes respawnFlash {
            0%, 70% { opacity: 1; }
            71%, 100% { opacity: 0.05; }
        }

        .platform {
            position: absolute;
            background: linear-gradient(45deg, var(--neon-purple), var(--dark-surface));
            border-radius: 6px;
            box-shadow: var(--glow) rgba(139, 92, 246, 0.3);
            will-change: transform;
            contain: layout style paint;
        }

        .collectible {
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, var(--neon-green) 0%, var(--neon-blue) 70%);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--neon-green);
            animation: collectibleFloat 2s ease-in-out infinite;
            will-change: transform;
            contain: layout style paint;
        }

        .collectible::before {
            content: '💎';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        @keyframes collectibleFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(180deg); }
        }

        .enemy {
            position: absolute;
            background: linear-gradient(45deg, var(--neon-orange), #ff4444);
            border-radius: 50%;
            box-shadow: var(--glow) var(--neon-orange);
            animation: enemyPulse 1.5s ease-in-out infinite;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        .enemy::before {
            content: '👾';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        @keyframes enemyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .goal {
            position: absolute;
            width: 50px;
            height: 80px;
            background: linear-gradient(0deg, var(--neon-green), var(--neon-blue));
            border-radius: 12px;
            box-shadow: var(--glow) var(--neon-green);
            animation: goalBeacon 2s ease-in-out infinite;
            will-change: transform;
            contain: layout style paint;
        }

        .goal::before {
            content: '🌀';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            animation: goalSpin 3s linear infinite;
        }

        @keyframes goalBeacon {
            0%, 100% { 
                box-shadow: var(--glow) var(--neon-green);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px var(--neon-green), 0 0 60px var(--neon-blue);
                transform: scale(1.05);
            }
        }

        @keyframes goalSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Overlay System */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .overlay.active {
            display: flex;
            opacity: 1;
        }

        .overlay-content {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-deep), var(--glow) rgba(0, 212, 255, 0.2);
        }

        .overlay-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: var(--glow) currentColor;
        }

        .success { color: var(--neon-green); }
        .danger { color: var(--neon-orange); }

        /* Pause Overlay */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(15px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pause-overlay.active {
            display: flex;
            opacity: 1;
        }

        .pause-content {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: var(--shadow-deep), var(--glow) rgba(255, 59, 59, 0.2);
        }

        .pause-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--neon-red);
            text-shadow: var(--glow) var(--neon-red);
        }

        /* Story buttons */
        .story-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Animazioni */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }
        
        @keyframes messageSlide {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes collectEffect {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* CORREZIONE MOBILE - Rimuovo scale problematico */
        @media (max-width: 480px) {
            .hud-layout {
                padding: 4px 8px;
                gap: 4px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .neo-btn {
                padding: 4px 6px;
                font-size: 0.55rem;
                min-width: 28px;
            }

            .player-panel,
            .energy-system {
                padding: 4px 6px;
            }

            .metric-card {
                padding: 3px 5px;
            }

            .story-content {
                padding: 15px;
            }

            .futuristic-input {
                max-width: 250px;
                padding: 6px 10px;
            }

            .launch-button {
                min-width: 160px;
                padding: 6px 16px;
            }
            
            /* Fix viewport per portrait */
            .game-container {
                width: 100vw;
                height: 100vh;
                /* Rimuovo transform scale problematico */
            }
            
            /* Camera fix per mobile */
            .world {
                width: 150vw; /* Riduco larghezza mondo per mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-background">
        <div class="background-layer stars" id="starsLayer"></div>
        <div class="energy-wave"></div>
    </div>

    <!-- Story Overlay -->
    <div id="storyOverlay" class="story-overlay">
        <div class="story-content">
            <div id="storyTitle" class="story-title">LIVELLO 1</div>
            <div id="storyText" class="story-text">Loading story...</div>
            <div class="story-buttons">
                <button id="storyActionBtn" class="btn" onclick="handleStoryAction()">CONTINUA</button>
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div id="pauseOverlay" class="pause-overlay">
        <div class="pause-content">
            <div class="pause-title">⏸️ PAUSA</div>
            <p style="margin-bottom: 20px; font-size: 1rem; color: rgba(255, 255, 255, 0.8);">
                Il gioco è in pausa. Prenditi una pausa, esploratore!
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn" onclick="resumeGame()">▶️ RIPRENDI</button>
                <button class="btn" onclick="restartGame()">🔄 RIAVVIA GIOCO</button>
                <button class="btn" style="background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));" onclick="goHomeFromPause()">🏠 MENU PRINCIPALE</button>
            </div>
        </div>
    </div>

    <!-- MENU PRINCIPALE -->
    <div id="mainMenu" class="screen active">
        <div class="main-menu-container">
            <!-- Logo e titolo -->
            <div class="retro-logo">
                <div class="retro-text">RETROAVIA</div>
                <div class="dark-chronicles">The Dark Chronicles</div>
            </div>
            
            <!-- Mission briefing compatto -->
            <div class="mission-briefing">
                <div class="briefing-intro">
                    🌌 <strong>L'Osservatorio Quantico</strong> ha rilevato una <em>catastrofica destabilizzazione</em> nelle dimensioni digitali. 
                    Le entità corrotte stanno divorando la realtà stessa. Tu sei l'ultimo <strong>Esploratore Dimensionale</strong> rimasto.
                </div>
                
                <div class="mission-cards">
                    <div class="mission-card objective-card">
                        <span class="card-icon">🎯</span>
                        <div class="card-title">MISSIONE CRITICA</div>
                        <div class="card-description">
                            Raccogli tutti i cristalli energetici e raggiungi i portali dimensionali. 
                            Ogni cristallo stabilizza un frammento di realtà.
                        </div>
                    </div>
                    
                    <div class="mission-card controls-card">
                        <span class="card-icon">🎮</span>
                        <div class="card-title">COMANDI TATTICI</div>
                        <div class="card-description">
                            <strong>← →</strong> Movimento<br>
                            <strong>SPAZIO</strong> Salto quantico<br>
                            <strong>P</strong> Pausa tattica<br>
                            <strong>R</strong> Reset dimensionale
                        </div>
                    </div>
                    
                    <div class="mission-card rewards-card">
                        <span class="card-icon">🏆</span>
                        <div class="card-title">RICOMPENSE LEGGENDARIE</div>
                        <div class="card-description">
                            <strong>Dimensione Gamma:</strong> Sconto 3%<br>
                            <strong>Dimensione Omega:</strong> Sconto 5%<br>
                            <strong>Completamento:</strong> Gloria eterna!
                        </div>
                    </div>
                </div>
            </div>
            
            /* Input section */
            <div class="player-input-section">
                <div class="input-label">🚀 Identificativo Esploratore</div>
                <input type="text" id="playerName" class="futuristic-input" placeholder="Inserisci il tuo nome da eroe..." maxlength="12">
                <div>
                    <button class="launch-button" onclick="startGame()">
                        🌌 INIZIA ESPLORAZIONE
                    </button>
                </div>
                
                <!-- Link Instagram -->
                <div style="margin-top: 30px; text-align: center;">
                    <a href="https://www.instagram.com/retroavia_" target="_blank" rel="noopener noreferrer" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 10px;
                        background: linear-gradient(45deg, #E4405F, #C13584, #833AB4);
                        color: white;
                        padding: 12px 20px;
                        text-decoration: none;
                        border-radius: 25px;
                        font-family: 'Orbitron', monospace;
                        font-size: 0.9rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(196, 53, 132, 0.3);
                        animation: fadeInUp 1s ease-out 1.9s both;
                    " onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 25px rgba(196, 53, 132, 0.5)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(196, 53, 132, 0.3)'">
                        <span style="font-size: 1.2rem;">📷</span>
                        <span>Seguici su Instagram</span>
                        <span style="font-weight: 400; opacity: 0.9;">@retroavia_</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <div class="game-ui">
                <!-- HUD OTTIMIZZATO -->
                <div class="futuristic-hud">
                    <div class="hud-layout">
                        <!-- Player Info Panel -->
                        <div class="player-panel">
                            <div class="player-info">
                                <div class="player-avatar"></div>
                                <div class="player-details">
                                    <div class="player-name" id="hud-name">Explorer</div>
                                    <div class="player-level">
                                        Dimension <span class="level-badge" id="hud-level">1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Game Metrics -->
                        <div class="game-dashboard">
                            <div class="metric-card score-card">
                                <div class="metric-label">Score</div>
                                <div class="metric-value" id="hud-score">0</div>
                            </div>
                            <div class="metric-card time-card">
                                <div class="metric-label">Time</div>
                                <div class="metric-value" id="hud-time">0:00</div>
                            </div>
                            <div class="metric-card crystals-card">
                                <div class="metric-label">Crystals</div>
                                <div class="metric-value" id="hud-crystals">0/0</div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="control-cluster">
                            <button class="neo-btn home-btn" onclick="goHome()" title="Torna al menu">🏠</button>
                            <button class="neo-btn pause-btn" onclick="pauseGame()" title="Pausa (P)">⏸️</button>
                            <button class="neo-btn restart-btn" onclick="restartGame()" title="Riavvia Gioco (R)">🔄</button>
                        </div>
                        
                        <!-- Energy System -->
                        <div class="energy-system">
                            <div class="energy-icon"></div>
                            <div class="energy-display">
                                <div class="energy-label">Energy</div>
                                <div class="energy-bar" id="energy-bar">
                                    <div class="energy-orb"></div>
                                    <div class="energy-orb"></div>
                                    <div class="energy-orb"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio e Quality controls -->
                <div class="audio-controls">
                    <button id="audioToggle" class="audio-btn" onclick="toggleAudio()" title="Audio Toggle">🔊</button>
                    <button id="qualityToggle" class="quality-btn" onclick="toggleQuality()" title="Qualità Grafica">⚙️</button>
                </div>
            </div>
            
            <div id="world" class="world"></div>
            
            <!-- Mobile Controls -->
            <div class="mobile-controls">
                <div class="control-group">
                    <div class="control-btn" id="leftBtn">←</div>
                    <div class="control-btn" id="rightBtn">→</div>
                </div>
                <div class="control-group">
                    <div class="control-btn" id="jumpBtn">↑</div>
                </div>
            </div>
            
            <!-- Mobile Zoom Controls -->
            <div class="mobile-zoom-controls">
                <div class="zoom-btn" id="zoomInBtn" title="Zoom In">+</div>
                <div class="zoom-btn" id="zoomOutBtn" title="Zoom Out">−</div>
                <div class="zoom-btn" id="zoomResetBtn" title="Reset Zoom">⌂</div>
            </div>
        </div>
    </div>

    <!-- Game Overlay -->
    <div id="gameOverlay" class="overlay">
        <div class="overlay-content">
            <div id="overlayTitle" class="overlay-title">Livello Completato!</div>
            <div id="overlayContent"></div>
            <button id="overlayButton" class="btn" onclick="nextAction()">CONTINUA</button>
        </div>
    </div>

    <script>
        // Initialize game manager globally
        let gameManager = null;

        // Enhanced Audio Manager con Musica Dinamica
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.musicGain = null;
                this.sfxGain = null;
                this.isEnabled = true;
                this.sounds = {};
                this.musicVolume = 0.12;
                this.sfxVolume = 0.35;
                this.musicOscillators = [];
                this.currentMusicLevel = 0;
                this.init();
            }

            async init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.musicGain = this.audioContext.createGain();
                    this.sfxGain = this.audioContext.createGain();
                    
                    this.masterGain.connect(this.audioContext.destination);
                    this.musicGain.connect(this.masterGain);
                    this.sfxGain.connect(this.masterGain);
                    
                    this.masterGain.gain.value = this.isEnabled ? 1 : 0;
                    this.musicGain.gain.value = this.musicVolume;
                    this.sfxGain.gain.value = this.sfxVolume;
                    
                    this.createSoundEffects();
                    this.startBackgroundMusic();
                } catch (error) {
                    console.warn('Audio not supported:', error);
                    this.isEnabled = false;
                }
            }

            // Musica dinamica per livello
            startLevelMusic(level) {
                if (this.currentMusicLevel === level) return;
                
                this.currentMusicLevel = level;
                this.stopMusic();
                
                const levelMusics = {
                    1: this.createLevelMusic1.bind(this),
                    2: this.createLevelMusic2.bind(this),
                    3: this.createLevelMusic3.bind(this),
                    4: this.createLevelMusic4.bind(this),
                    5: this.createLevelMusic5.bind(this)
                };
                
                const musicFunction = levelMusics[level] || this.createLevelMusic1.bind(this);
                setTimeout(() => musicFunction(), 500);
            }

            createLevelMusic1() {
                this.playMusicLoop([
                    [110, 146.83, 174.61],
                    [87.31, 130.81, 174.61],
                    [130.81, 164.81, 196],
                    [98, 146.83, 185]
                ], 12, 'sine');
            }

            createLevelMusic2() {
                this.playMusicLoop([
                    [164.81, 196, 246.94],
                    [146.83, 174.61, 220],
                    [130.81, 164.81, 196],
                    [123.47, 155.56, 185]
                ], 10, 'triangle');
            }

            createLevelMusic3() {
                this.playMusicLoop([
                    [116.54, 146.83, 174.61],
                    [103.83, 130.81, 155.56],
                    [110, 138.59, 164.81],
                    [98, 123.47, 146.83]
                ], 8, 'square');
            }

            createLevelMusic4() {
                this.playMusicLoop([
                    [146.83, 185, 220],
                    [164.81, 207.65, 246.94],
                    [174.61, 220, 261.63],
                    [185, 233.08, 277.18]
                ], 9, 'sine');
            }

            createLevelMusic5() {
                this.playMusicLoop([
                    [82.41, 103.83, 130.81],
                    [87.31, 110, 138.59],
                    [92.50, 116.54, 146.83],
                    [98, 123.47, 155.56]
                ], 14, 'sawtooth');
            }

            playMusicLoop(chords, duration, waveType) {
                if (!this.audioContext || !this.isEnabled) return;
                
                const playLoop = () => {
                    if (!this.isEnabled || !this.audioContext) return;
                    
                    this.musicOscillators.forEach(osc => {
                        try { osc.stop(); } catch(e) {}
                    });
                    this.musicOscillators = [];
                    
                    const now = this.audioContext.currentTime;
                    
                    chords.forEach((chord, chordIndex) => {
                        const chordTime = now + (chordIndex * duration / 4);
                        
                        chord.forEach((freq, noteIndex) => {
                            const osc = this.audioContext.createOscillator();
                            const gain = this.audioContext.createGain();
                            
                            osc.connect(gain);
                            gain.connect(this.musicGain);
                            
                            osc.frequency.setValueAtTime(freq, chordTime);
                            osc.type = waveType;
                            
                            const volume = 0.04 + (noteIndex * 0.01);
                            gain.gain.setValueAtTime(0, chordTime);
                            gain.gain.linearRampToValueAtTime(volume, chordTime + 0.1);
                            gain.gain.exponentialRampToValueAtTime(0.01, chordTime + duration / 4 - 0.1);
                            gain.gain.linearRampToValueAtTime(0.001, chordTime + duration / 4);
                            
                            osc.start(chordTime);
                            osc.stop(chordTime + duration / 4);
                            
                            this.musicOscillators.push(osc);
                        });
                    });
                    
                    setTimeout(() => playLoop(), duration * 1000);
                };
                
                playLoop();
            }

            stopMusic() {
                this.musicOscillators.forEach(osc => {
                    try { osc.stop(); } catch(e) {}
                });
                this.musicOscillators = [];
            }

            startBackgroundMusic() {
                if (!this.audioContext || !this.isEnabled) return;
                
                const playMusicLoop = () => {
                    if (!this.isEnabled || !this.audioContext || this.currentMusicLevel > 0) return;
                    
                    this.musicOscillators.forEach(osc => {
                        try { osc.stop(); } catch(e) {}
                    });
                    this.musicOscillators = [];
                    
                    const now = this.audioContext.currentTime;
                    const duration = 12;
                    
                    const chords = [
                        [110, 146.83, 174.61],
                        [87.31, 130.81, 174.61],
                        [130.81, 164.81, 196],
                        [98, 146.83, 185]
                    ];
                    
                    chords.forEach((chord, chordIndex) => {
                        const chordTime = now + (chordIndex * duration / 4);
                        
                        chord.forEach((freq, noteIndex) => {
                            const osc1 = this.audioContext.createOscillator();
                            const gain1 = this.audioContext.createGain();
                            
                            osc1.connect(gain1);
                            gain1.connect(this.musicGain);
                            
                            osc1.frequency.setValueAtTime(freq, chordTime);
                            osc1.type = 'sine';
                            
                            gain1.gain.setValueAtTime(0, chordTime);
                            gain1.gain.linearRampToValueAtTime(0.06, chordTime + 0.1);
                            gain1.gain.exponentialRampToValueAtTime(0.015, chordTime + duration / 4 - 0.1);
                            gain1.gain.linearRampToValueAtTime(0.001, chordTime + duration / 4);
                            
                            osc1.start(chordTime);
                            osc1.stop(chordTime + duration / 4);
                            
                            this.musicOscillators.push(osc1);
                        });
                    });
                    
                    setTimeout(() => playMusicLoop(), duration * 1000);
                };
                
                setTimeout(() => playMusicLoop(), 1000);
            }

            createSoundEffects() {
                if (!this.audioContext) return;
                
                this.sounds = {
                    jump: () => this.createBeep(450, 0.12, 'square', [450, 650]),
                    collect: () => this.createMelody([523, 659, 784, 1047], 0.08),
                    hit: () => this.createDeathSound(), // NUOVO SUONO MORTE
                    complete: () => this.createMelody([523, 659, 784, 1047, 1319], 0.2),
                    button: () => this.createBeep(800, 0.06, 'triangle'),
                    levelStart: () => this.createMelody([392, 523, 659], 0.15)
                };
            }

            // NUOVO: Suono specifico per la morte del giocatore
            createDeathSound() {
                if (!this.audioContext || !this.isEnabled) return;
                
                // Suono drammatico di morte con sweep discendente
                const osc1 = this.audioContext.createOscillator();
                const osc2 = this.audioContext.createOscillator();
                const gain1 = this.audioContext.createGain();
                const gain2 = this.audioContext.createGain();
                const filter = this.audioContext.createBiquadFilter();
                
                osc1.connect(gain1);
                osc2.connect(gain2);
                gain1.connect(filter);
                gain2.connect(filter);
                filter.connect(this.sfxGain);
                
                // Primo oscillatore: sweep drammatico
                osc1.frequency.setValueAtTime(800, this.audioContext.currentTime);
                osc1.frequency.exponentialRampToValueAtTime(200, this.audioContext.currentTime + 0.8);
                osc1.type = 'sawtooth';
                
                // Secondo oscillatore: effetto distortion
                osc2.frequency.setValueAtTime(400, this.audioContext.currentTime);
                osc2.frequency.exponentialRampToValueAtTime(100, this.audioContext.currentTime + 0.8);
                osc2.type = 'square';
                
                // Filtro passa-basso per effetto drammatico
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(2000, this.audioContext.currentTime);
                filter.frequency.exponentialRampToValueAtTime(300, this.audioContext.currentTime + 0.8);
                
                // Envelope dei volumi
                gain1.gain.setValueAtTime(0, this.audioContext.currentTime);
                gain1.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.05);
                gain1.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.8);
                
                gain2.gain.setValueAtTime(0, this.audioContext.currentTime);
                gain2.gain.linearRampToValueAtTime(0.15, this.audioContext.currentTime + 0.1);
                gain2.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.8);
                
                osc1.start();
                osc2.start();
                osc1.stop(this.audioContext.currentTime + 0.8);
                osc2.stop(this.audioContext.currentTime + 0.8);
            }

            createBeep(frequency, duration, type = 'sine', sweep = null) {
                if (!this.audioContext || !this.isEnabled) return;
                
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(this.sfxGain);
                
                osc.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                osc.type = type;
                
                if (sweep && sweep.length === 2) {
                    osc.frequency.linearRampToValueAtTime(sweep[1], this.audioContext.currentTime + duration);
                }
                
                gain.gain.setValueAtTime(0, this.audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(0.25, this.audioContext.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                osc.start();
                osc.stop(this.audioContext.currentTime + duration);
            }

            createMelody(frequencies, noteDuration) {
                if (!this.audioContext || !this.isEnabled) return;
                
                frequencies.forEach((freq, i) => {
                    setTimeout(() => {
                        this.createBeep(freq, noteDuration, 'triangle');
                    }, i * noteDuration * 350);
                });
            }

            playSound(soundName) {
                if (this.sounds[soundName] && this.isEnabled) {
                    this.sounds[soundName]();
                }
            }

            toggle() {
                this.isEnabled = !this.isEnabled;
                if (this.masterGain) {
                    this.masterGain.gain.value = this.isEnabled ? 1 : 0;
                }
                
                if (!this.isEnabled) {
                    this.stopMusic();
                } else {
                    if (this.currentMusicLevel > 0) {
                        this.startLevelMusic(this.currentMusicLevel);
                    } else {
                        setTimeout(() => this.startBackgroundMusic(), 100);
                    }
                }
                
                const btn = document.getElementById('audioToggle');
                if (btn) {
                    btn.textContent = this.isEnabled ? '🔊' : '🔇';
                    btn.className = this.isEnabled ? 'audio-btn' : 'audio-btn muted';
                }
            }

            resumeContext() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }
        }

        // High-Performance Rendering Engine con WebGL
        class RenderEngine {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.webglSupported = false;
                this.performanceMode = this.detectPerformanceMode();
                this.init();
            }

            detectPerformanceMode() {
                const ua = navigator.userAgent;
                const isOldDevice = /Android [1-4]|iPhone OS [1-9]_|CPU OS [1-9]_/.test(ua);
                const isLowRAM = navigator.deviceMemory && navigator.deviceMemory < 2;
                const isSlowCPU = navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4;
                
                if (isOldDevice || isLowRAM || isSlowCPU) {
                    return 'low';
                }
                
                return 'high';
            }

            init() {
                try {
                    this.canvas = document.createElement('canvas');
                    this.canvas.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                        z-index: 5;
                    `;
                    
                    const gl = this.canvas.getContext('webgl') || this.canvas.getContext('experimental-webgl');
                    if (gl) {
                        this.webglSupported = true;
                        this.setupWebGL(gl);
                        console.log('🚀 WebGL Renderer attivato');
                    } else {
                        this.ctx = this.canvas.getContext('2d');
                        console.log('📱 Canvas 2D Renderer (WebGL non supportato)');
                    }
                    
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());
                    
                } catch (error) {
                    console.warn('Render engine initialization failed:', error);
                }
            }

            setupWebGL(gl) {
                this.gl = gl;
                
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    attribute vec3 a_color;
                    uniform vec2 u_resolution;
                    varying vec3 v_color;
                    
                    void main() {
                        vec2 position = ((a_position / u_resolution) * 2.0) - 1.0;
                        gl_Position = vec4(position * vec2(1, -1), 0, 1);
                        v_color = a_color;
                        gl_PointSize = 3.0;
                    }
                `;

                const fragmentShaderSource = `
                    precision mediump float;
                    varying vec3 v_color;
                    
                    void main() {
                        gl_FragColor = vec4(v_color, 0.8);
                    }
                `;

                const vertexShader = this.createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
                const fragmentShader = this.createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
                
                if (vertexShader && fragmentShader) {
                    this.program = this.createProgram(gl, vertexShader, fragmentShader);
                }
            }

            createShader(gl, type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);
                
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.warn('Shader compile error:', gl.getShaderInfoLog(shader));
                    gl.deleteShader(shader);
                    return null;
                }
                
                return shader;
            }

            createProgram(gl, vertexShader, fragmentShader) {
                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);
                
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    console.warn('Program link error:', gl.getProgramInfoLog(program));
                    gl.deleteProgram(program);
                    return null;
                }
                
                return program;
            }

            resizeCanvas() {
                if (!this.canvas) return;
                
                const worldEl = document.getElementById('world');
                if (!worldEl) return;
                
                const rect = worldEl.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                
                if (this.gl) {
                    this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                }
            }

            renderParticles(particles) {
                if (!this.webglSupported || !this.gl || !this.program) return;
                
                if (this.performanceMode === 'low') return;
                
                const gl = this.gl;
                gl.useProgram(this.program);
                
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                
                particles.forEach(particle => {
                    gl.drawArrays(gl.POINTS, 0, 1);
                });
            }

            setQualityMode(mode) {
                this.performanceMode = mode;
                
                if (mode === 'low') {
                    document.documentElement.style.setProperty('--animation-speed', '0.5s');
                    const effects = document.querySelectorAll('.energy-wave, .collectible, .enemy');
                    effects.forEach(el => {
                        el.style.animationDuration = '4s';
                    });
                } else {
                    document.documentElement.style.setProperty('--animation-speed', '1s');
                }
            }
        }

        // Story System Manager
        class StoryManager {
            constructor() {
                this.stories = {
                    intro1: {
                        title: "🌌 DIMENSIONE ALPHA - IL RISVEGLIO",
                        text: `L'Osservatorio Quantico ha rilevato una catastrofica destabilizzazione nelle dimensioni digitali. Le entità corrotte stanno divorando la realtà stessa.

Tu sei l'ultimo Esploratore Dimensionale rimasto. I cristalli energetici sono la chiave per stabilizzare ogni dimensione prima che collassi nel vuoto.

La tua prima missione: raccogliere tutti i cristalli nella Dimensione Alpha e raggiungere il portale di stabilizzazione. Il tempo è contro di te, esploratore.`,
                        level: 1,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro1: {
                        title: "✨ ALPHA STABILIZZATA",
                        text: `Eccellente lavoro! La Dimensione Alpha è stata stabilizzata. I suoi abitanti digitali possono ora respirare di nuovo.

Ma questo è solo l'inizio. I sensori rilevano anomalie ancora più gravi nelle dimensioni successive. Le entità corrotte stanno imparando dai tuoi movimenti.

Preparati per la Dimensione Beta, dove la gravità sfida le leggi della fisica...`,
                        level: 1,
                        actionText: "CONTINUA"
                    },
                    intro2: {
                        title: "🌊 DIMENSIONE BETA - LE ISOLE FLUTTUANTI",
                        text: `Benvenuto nella Dimensione Beta, un reticolo di isole energetiche sospese nel vuoto quantico. Qui la gravità segue regole diverse.

Le piattaforme sono instabili e le entità corrotte hanno sviluppato nuove tattiche. Dovrai saltare con precisione millimetrica per sopravvivere.

I cristalli qui contengono energia pura concentrata. Raccoglili tutti prima che le isole si disgreghino nel caos dimensionale.`,
                        level: 2,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro2: {
                        title: "🏆 BETA PURIFICATA",
                        text: `Le Isole Fluttuanti tornano a brillare! La tua agilità ha impressionato anche gli antichi Guardiani Digitali.

Ma attenzione: i rapporti indicano che la prossima dimensione è controllata da entità corrotte evolute. Preparati alla sfida più dura.

Il Guanto di Sfida ti aspetta, dove ogni passo potrebbe essere l'ultimo...`,
                        level: 2,
                        actionText: "CONTINUA"
                    },
                    intro3: {
                        title: "⚔️ DIMENSIONE GAMMA - IL GUANTO DI SFIDA",
                        text: `Hai raggiunto la temuta Dimensione Gamma, conosciuta come "Il Guanto". Qui ogni passo è una trappola, ogni salto una scommessa con la morte.

Le entità corrotte hanno organizzato una difesa coordinata. Ti stanno aspettando.

Completa questa prova e guadagnerai il rispetto dell'intera Confederazione Digitale. I cristalli qui non sono solo energia: sono la chiave per ricompense leggendarie.`,
                        level: 3,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro3: {
                        title: "🎖️ EROE DELLA GAMMA",
                        text: `INCREDIBILE! Hai conquistato il Guanto di Sfida! La Confederazione Digitale ti conferisce il titolo di Eroe Dimensionale.

Come ricompensa per il tuo coraggio, hai sbloccato un codice sconto speciale per il nostro negozio dimensionale.

Ma la guerra non è finita. Le dimensioni finali ti aspettano con sfide che metteranno alla prova ogni fibra del tuo essere.`,
                        level: 3,
                        actionText: "CONTINUA"
                    },
                    intro4: {
                        title: "🎯 DIMENSIONE DELTA - PRECISIONE ASSOLUTA",
                        text: `Benvenuto nella Dimensione Delta, dove solo i maestri della precisione possono sopravvivere. Ogni piattaforma è più piccola, ogni salto più pericoloso.

Le entità corrotte qui hanno sviluppato tecniche di caccia perfezionate. Si muovono come ombre, colpiscono come fulmini.

Non c'è spazio per l'errore. Un singolo passo falso significa il ritorno al vuoto quantico. Dimostra di essere degno del titolo di Maestro Esploratore.`,
                        level: 4,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro4: {
                        title: "🏅 MAESTRO DELLA PRECISIONE",
                        text: `La tua precisione è leggendaria! La Dimensione Delta si inchina al tuo passaggio. Gli archivi digitali registreranno per sempre la tua impresa.

Rimane un'ultima sfida. La Dimensione Omega, dove risiede l'Entità Suprema Corrotta. Il destino di tutte le realtà digitali è nelle tue mani.

L'ultima battaglia ti attende nel cuore delle tenebre...`,
                        level: 4,
                        actionText: "CONTINUA"
                    },
                    intro5: {
                        title: "💀 DIMENSIONE OMEGA - LO SCONTRO FINALE",
                        text: `Questo è tutto. La Dimensione Omega, cuore della corruzione, regno dell'Entità Suprema. Qui dove tutto è iniziato, tutto deve finire.

Le piattaforme si dissolvono mentre cammini. Le entità corrotte attaccano con furia disperata. E in fondo al livello, TI aspetta.

Fallire qui significa la fine di ogni realtà digitale. Vincere significa diventare una leggenda immortale. Sei pronto, Esploratore Supremo?`,
                        level: 5,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro5: {
                        title: "👑 SALVATORE DELLE DIMENSIONI",
                        text: `L'HAI FATTO! L'Entità Suprema è stata purificata, le dimensioni sono al sicuro, la realtà digitale è salva!

Il tuo nome risuonerà per l'eternità in ogni dimensione. Sei diventato il Salvatore Leggendario, colui che ha riportato l'equilibrio nel multiverso.

Come ricompensa finale, hai sbloccato il codice sconto supremo e la gloria eterna nella storia interdimensionale!`,
                        level: 5,
                        actionText: "CONTINUA"
                    }
                };
            }

            showStory(level, type = 'intro') {
                const key = type + level;
                const story = this.stories[key];
                
                if (!story) return;

                document.getElementById('storyTitle').textContent = story.title;
                document.getElementById('storyText').textContent = story.text;
                
                const actionBtn = document.getElementById('storyActionBtn');
                actionBtn.textContent = story.actionText;
                
                document.getElementById('storyOverlay').classList.add('active');
            }

            hideStory() {
                document.getElementById('storyOverlay').classList.remove('active');
            }
        }

        // High-Performance Game Engine
        class Game {
            constructor() {
                this.state = 'menu';
                this.currentLevel = 1;
                this.maxLevels = 5;
                this.isPaused = false;
                
                this.player = {
                    x: 50, y: 300, vx: 0, vy: 0,
                    width: 40, height: 40,
                    onGround: false, canJump: true,
                    energy: 3, 
                    name: '', coyoteTime: 0,
                    isDying: false // NUOVO: flag per animazione morte
                };
                
                this.camera = { x: 0, targetX: 0 };
                this.score = 0;
                this.startTime = 0;
                this.gameTime = 0;
                this.keys = {};
                this.entities = [];
                this.running = false;
                this.worldWidth = 1800;
                this.gravity = 0.8;
                this.friction = 0.88;
                
                this.lastGoalMessage = 0;
                this.goalMessageCooldown = 2000;
                
                // Performance optimization
                this.lastRenderTime = 0;
                this.targetFPS = 60;
                this.frameInterval = 1000 / this.targetFPS;
                this.visibleEntities = [];
                this.updateCounter = 0;
                this.deltaTime = 0;

                this.story = new StoryManager();
                this.audioManager = new AudioManager();
                this.renderEngine = new RenderEngine();
                this.setupEventListeners();
                this.setupMobileControls();
                this.initBackground();
            }

            initBackground() {
                this.createStars();
            }

            createStars() {
                const starsLayer = document.getElementById('starsLayer');
                if (!starsLayer) return;
                
                starsLayer.innerHTML = '';
                
                for (let i = 0; i < 25; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.cssText = `
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        width: ${Math.random() * 2 + 1}px;
                        height: ${Math.random() * 2 + 1}px;
                        opacity: ${Math.random() * 0.4 + 0.2};
                    `;
                    starsLayer.appendChild(star);
                }
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    if (this.isPaused) return;
                    this.keys[e.code] = true;
                    if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Space'].includes(e.code)) {
                        e.preventDefault();
                    }
                    
                    if (e.code === 'KeyP' || e.code === 'Escape') {
                        if (this.state === 'playing') {
                            this.pauseGame();
                        }
                    }
                    
                    if (e.code === 'KeyR' && this.state === 'playing') {
                        this.restartLevel();
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });

                const playerNameInput = document.getElementById('playerName');
                if (playerNameInput) {
                    playerNameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            startGame();
                        }
                    });
                }

                document.addEventListener('click', () => {
                    this.audioManager.resumeContext();
                }, { once: true });
            }

            setupMobileControls() {
                const controls = [
                    { id: 'leftBtn', key: 'ArrowLeft' },
                    { id: 'rightBtn', key: 'ArrowRight' },
                    { id: 'jumpBtn', key: 'Space' }
                ];

                controls.forEach(({ id, key }) => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            if (!this.isPaused) this.keys[key] = true;
                        }, { passive: false });
                        btn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            this.keys[key] = false;
                        }, { passive: false });
                        btn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            if (!this.isPaused) this.keys[key] = true;
                        });
                        btn.addEventListener('mouseup', (e) => {
                            e.preventDefault();
                            this.keys[key] = false;
                        });
                    }
                });
            }

            // NUOVO: Setup controlli zoom mobile
            setupMobileZoom() {
                const zoomInBtn = document.getElementById('zoomInBtn');
                const zoomOutBtn = document.getElementById('zoomOutBtn');
                const zoomResetBtn = document.getElementById('zoomResetBtn');

                if (zoomInBtn) {
                    ['touchstart', 'mousedown'].forEach(event => {
                        zoomInBtn.addEventListener(event, (e) => {
                            e.preventDefault();
                            this.adjustMobileZoom(0.1);
                        }, { passive: false });
                    });
                }

                if (zoomOutBtn) {
                    ['touchstart', 'mousedown'].forEach(event => {
                        zoomOutBtn.addEventListener(event, (e) => {
                            e.preventDefault();
                            this.adjustMobileZoom(-0.1);
                        }, { passive: false });
                    });
                }

                if (zoomResetBtn) {
                    ['touchstart', 'mousedown'].forEach(event => {
                        zoomResetBtn.addEventListener(event, (e) => {
                            e.preventDefault();
                            this.resetMobileZoom();
                        }, { passive: false });
                    });
                }

                // Mostra controlli zoom solo su mobile
                const isMobile = window.innerWidth <= 768;
                const zoomControls = document.querySelector('.mobile-zoom-controls');
                if (zoomControls) {
                    zoomControls.style.display = isMobile ? 'flex' : 'none';
                }
            }

            // NUOVO: Gestione zoom mobile
            adjustMobileZoom(delta) {
                this.mobileZoom = Math.max(this.minZoom, Math.min(this.maxZoom, this.mobileZoom + delta));
                this.applyMobileZoom();
                this.audioManager.playSound('button');
            }

            resetMobileZoom() {
                this.mobileZoom = 1;
                this.applyMobileZoom();
                this.audioManager.playSound('button');
            }

            applyMobileZoom() {
                const gameContainer = document.querySelector('.game-container');
                if (gameContainer && window.innerWidth <= 768) {
                    gameContainer.style.transform = `scale(${this.mobileZoom})`;
                    gameContainer.style.transformOrigin = 'center center';
                    
                    // Aggiusta la posizione se necessario
                    if (this.mobileZoom < 1) {
                        gameContainer.style.position = 'relative';
                        gameContainer.style.top = '0';
                        gameContainer.style.left = '0';
                    }
                }
            }

            start(playerName) {
                this.player.name = playerName;
                this.currentLevel = 1;
                this.score = 0;
                this.player.energy = 3;
                this.isPaused = false;
                this.startTime = Date.now();
                this.state = 'story';
                this.story.showStory(1, 'intro');
            }

            startLevel() {
                document.body.classList.add('game-active');
                
                this.loadLevel();
                this.showScreen('gameScreen');
                this.state = 'playing';
                this.isPaused = false;
                this.running = true;
                
                // Applica zoom mobile se necessario
                setTimeout(() => this.applyMobileZoom(), 100);
                
                this.audioManager.startLevelMusic(this.currentLevel);
                this.audioManager.playSound('levelStart');
                
                if (this.renderEngine && this.renderEngine.canvas) {
                    const world = document.getElementById('world');
                    if (world && !world.contains(this.renderEngine.canvas)) {
                        world.appendChild(this.renderEngine.canvas);
                    }
                }
                
                this.gameLoop();
            }

            pauseGame() {
                if (this.state !== 'playing') return;
                this.isPaused = true;
                this.running = false;
                document.getElementById('pauseOverlay').classList.add('active');
                this.audioManager.playSound('button');
            }

            resumeGame() {
                if (this.state !== 'playing') return;
                this.isPaused = false;
                this.running = true;
                document.getElementById('pauseOverlay').classList.remove('active');
                this.audioManager.playSound('button');
                this.gameLoop();
            }

            restartLevel() {
                this.showRestartConfirmation();
            }

            showRestartConfirmation() {
                const confirmOverlay = document.createElement('div');
                confirmOverlay.id = 'restartConfirmOverlay';
                confirmOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(10, 10, 15, 0.95);
                    backdrop-filter: blur(15px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2500;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;

                const confirmContent = document.createElement('div');
                confirmContent.style.cssText = `
                    background: var(--glass);
                    border: 2px solid var(--neon-orange);
                    border-radius: 15px;
                    padding: 30px;
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: var(--shadow-deep), 0 0 30px rgba(255, 107, 53, 0.3);
                `;

                confirmContent.innerHTML = `
                    <div style="font-family: 'Orbitron', monospace; font-size: 1.8rem; font-weight: 900; margin-bottom: 20px; color: var(--neon-orange); text-shadow: 0 0 10px var(--neon-orange);">
                        ⚠️ CONFERMA RIAVVIO
                    </div>
                    <p style="font-size: 1.1rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 25px; line-height: 1.5;">
                        Sei sicuro di voler <strong style="color: var(--neon-red);">riavviare completamente</strong> il gioco?
                    </p>
                    <p style="font-size: 0.9rem; color: var(--neon-orange); margin-bottom: 30px;">
                        🔄 Tornerai al <strong>Livello 1</strong> con <strong>3 vite</strong><br>
                        💯 Il punteggio attuale andrà <strong>perso</strong>
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button id="confirmRestart" style="
                            background: linear-gradient(45deg, var(--neon-red), var(--neon-orange));
                            border: none;
                            color: white;
                            padding: 12px 25px;
                            font-family: 'Orbitron', monospace;
                            font-size: 0.9rem;
                            font-weight: 700;
                            cursor: pointer;
                            border-radius: 10px;
                            min-width: 140px;
                            transition: all 0.3s ease;
                            text-transform: uppercase;
                        ">🔄 SÌ, RIAVVIA</button>
                        <button id="cancelRestart" style="
                            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
                            border: none;
                            color: white;
                            padding: 12px 25px;
                            font-family: 'Orbitron', monospace;
                            font-size: 0.9rem;
                            font-weight: 700;
                            cursor: pointer;
                            border-radius: 10px;
                            min-width: 140px;
                            transition: all 0.3s ease;
                            text-transform: uppercase;
                        ">❌ ANNULLA</button>
                    </div>
                `;

                confirmOverlay.appendChild(confirmContent);
                document.body.appendChild(confirmOverlay);

                setTimeout(() => {
                    confirmOverlay.style.opacity = '1';
                }, 10);

                document.getElementById('confirmRestart').addEventListener('click', () => {
                    this.audioManager.playSound('button');
                    this.hideRestartConfirmation();
                    this.performFullRestart();
                });

                document.getElementById('cancelRestart').addEventListener('click', () => {
                    this.audioManager.playSound('button');
                    this.hideRestartConfirmation();
                });

                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.audioManager.playSound('button');
                        this.hideRestartConfirmation();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }

            hideRestartConfirmation() {
                const overlay = document.getElementById('restartConfirmOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.remove();
                        }
                    }, 300);
                }
            }

            performFullRestart() {
                this.isPaused = false;
                this.running = false;
                
                if (document.getElementById('pauseOverlay').classList.contains('active')) {
                    document.getElementById('pauseOverlay').classList.remove('active');
                }
                
                this.currentLevel = 1;
                this.score = 0;
                this.player.energy = 3;
                this.startTime = Date.now();
                this.state = 'story';
                
                this.showMessage('🔄 Gioco riavviato! Iniziando dal Livello 1...');
                
                setTimeout(() => {
                    this.story.showStory(1, 'intro');
                }, 500);
            }

            goHomeFromPause() {
                this.isPaused = false;
                this.running = false;
                document.getElementById('pauseOverlay').classList.remove('active');
                this.state = 'menu';
                this.audioManager.playSound('button');
                this.showScreen('mainMenu');
            }

            loadLevel() {
                const levels = [
                    // Level 1: Tutorial
                    {
                        platforms: [
                            { x: 0, y: 500, w: 200, h: 20 },
                            { x: 300, y: 450, w: 150, h: 20 },
                            { x: 550, y: 400, w: 150, h: 20 },
                            { x: 800, y: 350, w: 200, h: 20 }
                        ],
                        collectibles: [
                            { x: 350, y: 420 },
                            { x: 600, y: 370 },
                            { x: 850, y: 320 }
                        ],
                        enemies: [
                            { x: 400, y: 420, w: 30, h: 30, vx: 1, range: 100, platformBound: true }
                        ],
                        goal: { x: 950, y: 270 }
                    },
                    // Level 2: Floating Islands
                    {
                        platforms: [
                            { x: 0, y: 520, w: 150, h: 20 },
                            { x: 200, y: 460, w: 120, h: 20 },
                            { x: 380, y: 400, w: 120, h: 20 },
                            { x: 560, y: 340, w: 120, h: 20 },
                            { x: 740, y: 280, w: 120, h: 20 },
                            { x: 920, y: 220, w: 150, h: 20 }
                        ],
                        collectibles: [
                            { x: 240, y: 430 },
                            { x: 420, y: 370 },
                            { x: 600, y: 310 },
                            { x: 780, y: 250 }
                        ],
                        enemies: [
                            { x: 250, y: 430, w: 25, h: 25, vx: -1, range: 80, platformBound: true },
                            { x: 600, y: 310, w: 25, h: 25, vx: 1, range: 80, platformBound: true }
                        ],
                        goal: { x: 990, y: 140 }
                    },
                    // Level 3: The Gauntlet
                    {
                        platforms: [
                            { x: 0, y: 500, w: 120, h: 20 },
                            { x: 180, y: 450, w: 100, h: 20 },
                            { x: 340, y: 400, w: 100, h: 20 },
                            { x: 500, y: 350, w: 100, h: 20 },
                            { x: 660, y: 300, w: 100, h: 20 },
                            { x: 820, y: 250, w: 100, h: 20 },
                            { x: 980, y: 200, w: 120, h: 20 }
                        ],
                        collectibles: [
                            { x: 220, y: 420 },
                            { x: 380, y: 370 },
                            { x: 540, y: 320 },
                            { x: 700, y: 270 },
                            { x: 860, y: 220 }
                        ],
                        enemies: [
                            { x: 220, y: 420, w: 25, h: 25, vx: -1, range: 60, platformBound: true },
                            { x: 380, y: 370, w: 25, h: 25, vx: 1, range: 60, platformBound: true },
                            { x: 540, y: 320, w: 25, h: 25, vx: -1, range: 60, platformBound: true },
                            { x: 700, y: 270, w: 25, h: 25, vx: 1, range: 60, platformBound: true }
                        ],
                        goal: { x: 1040, y: 120 },
                        reward: "RETRO3"
                    },
                    // Level 4: Precision Platform
                    {
                        platforms: [
                            { x: 0, y: 480, w: 100, h: 20 },
                            { x: 150, y: 430, w: 80, h: 20 },
                            { x: 280, y: 380, w: 80, h: 20 },
                            { x: 410, y: 330, w: 80, h: 20 },
                            { x: 540, y: 280, w: 80, h: 20 },
                            { x: 670, y: 230, w: 80, h: 20 },
                            { x: 800, y: 180, w: 80, h: 20 },
                            { x: 930, y: 130, w: 100, h: 20 }
                        ],
                        collectibles: [
                            { x: 180, y: 400 },
                            { x: 310, y: 350 },
                            { x: 440, y: 300 },
                            { x: 570, y: 250 },
                            { x: 700, y: 200 },
                            { x: 830, y: 150 }
                        ],
                        enemies: [
                            { x: 310, y: 350, w: 25, h: 25, vx: 1, range: 50, platformBound: true },
                            { x: 570, y: 250, w: 25, h: 25, vx: -1, range: 50, platformBound: true },
                            { x: 830, y: 150, w: 25, h: 25, vx: 1, range: 50, platformBound: true }
                        ],
                        goal: { x: 980, y: 50 }
                    },
                    // Level 5: Final Challenge
                    {
                        platforms: [
                            { x: 0, y: 520, w: 80, h: 20 },
                            { x: 130, y: 480, w: 60, h: 20 },
                            { x: 240, y: 440, w: 60, h: 20 },
                            { x: 350, y: 400, w: 60, h: 20 },
                            { x: 460, y: 360, w: 60, h: 20 },
                            { x: 570, y: 320, w: 60, h: 20 },
                            { x: 680, y: 280, w: 60, h: 20 },
                            { x: 790, y: 240, w: 60, h: 20 },
                            { x: 900, y: 200, w: 60, h: 20 },
                            { x: 1010, y: 160, w: 80, h: 20 }
                        ],
                        collectibles: [
                            { x: 160, y: 450 },
                            { x: 270, y: 410 },
                            { x: 380, y: 370 },
                            { x: 490, y: 330 },
                            { x: 600, y: 290 },
                            { x: 710, y: 250 },
                            { x: 820, y: 210 }
                        ],
                        enemies: [
                            { x: 160, y: 450, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 270, y: 410, w: 25, h: 25, vx: 1, range: 40, platformBound: true },
                            { x: 380, y: 370, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 490, y: 330, w: 25, h: 25, vx: 1, range: 40, platformBound: true },
                            { x: 600, y: 290, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 930, y: 170, w: 35, h: 35, vx: 0, range: 30, platformBound: true }
                        ],
                        goal: { x: 1040, y: 80 },
                        reward: "RETRO5"
                    }
                ];

                const level = levels[this.currentLevel - 1];
                
                this.entities = [];
                this.player.x = 50;
                this.player.y = 400;
                this.player.vx = 0;
                this.player.vy = 0;
                this.player.onGround = false;
                this.player.isDying = false; // Reset flag morte
                this.camera.x = 0;
                this.camera.targetX = 0;
                
                this.lastGoalMessage = 0;

                level.platforms.forEach(p => {
                    this.entities.push({
                        type: 'platform',
                        x: p.x, y: p.y, w: p.w, h: p.h
                    });
                });

                level.collectibles.forEach(c => {
                    this.entities.push({
                        type: 'collectible',
                        x: c.x, y: c.y, w: 25, h: 25,
                        collected: false
                    });
                });

                level.enemies.forEach((e, index) => {
                    const enemy = {
                        type: 'enemy',
                        id: `enemy_${index}`,
                        x: e.x, y: e.y, w: e.w, h: e.h,
                        vx: e.vx, vy: 0, health: 1,
                        startX: e.x, range: e.range,
                        onGround: false, platformBound: e.platformBound || false,
                        currentPlatform: null
                    };
                    
                    if (enemy.platformBound) {
                        const platform = level.platforms.find(p => 
                            enemy.x >= p.x && enemy.x + enemy.w <= p.x + p.w &&
                            Math.abs(enemy.y + enemy.h - p.y) < 30
                        );
                        if (platform) {
                            enemy.currentPlatform = platform;
                            enemy.y = platform.y - enemy.h;
                        }
                    }
                    
                    this.entities.push(enemy);
                });

                this.entities.push({
                    type: 'goal',
                    x: level.goal.x, y: level.goal.y,
                    w: 50, h: 80
                });

                this.updateHUD();
            }

            gameLoop() {
                if (!this.running || this.isPaused) return;

                const currentTime = performance.now();
                this.deltaTime = currentTime - this.lastRenderTime;

                if (this.deltaTime >= this.frameInterval) {
                    this.update(this.deltaTime / 1000);
                    this.render();
                    this.lastRenderTime = currentTime;
                }

                requestAnimationFrame(() => this.gameLoop());
            }

            update(deltaTime) {
                if (this.isPaused || this.player.isDying) return; // Blocca update durante morte
                
                this.gameTime = Date.now() - this.startTime;
                this.updateCounter++;

                if (this.updateCounter % 60 === 0) {
                    this.updateTimer();
                }

                this.updatePlayer(deltaTime);
                this.updateEnemies(deltaTime);
                this.updateCamera(deltaTime);
                this.checkCollisions();

                if (this.updateCounter % 120 === 0) {
                    this.updateBackground();
                }
            }

            updatePlayer(deltaTime) {
                const p = this.player;
                if (p.isDying) return; // Blocca movimento durante morte
                
                const speed = 7.5;
                const jumpPower = 18;
                const acceleration = 2.0;

                if (this.keys.ArrowLeft) {
                    p.vx = Math.max(p.vx - acceleration, -speed);
                } else if (this.keys.ArrowRight) {
                    p.vx = Math.min(p.vx + acceleration, speed);
                } else {
                    p.vx *= this.friction;
                }

                if (this.keys.Space && (p.onGround || this.player.coyoteTime > 0) && p.canJump) {
                    p.vy = -jumpPower;
                    p.onGround = false;
                    p.canJump = false;
                    this.player.coyoteTime = 0;
                    this.audioManager.playSound('jump');
                }

                if (!this.keys.Space) {
                    p.canJump = true;
                }

                if (p.onGround) {
                    this.player.coyoteTime = 8;
                } else if (this.player.coyoteTime > 0) {
                    this.player.coyoteTime--;
                }

                p.vy += this.gravity;
                if (p.vy > 16) p.vy = 16;

                if (!this.keys.Space && p.vy < 0) {
                    p.vy *= 0.6;
                }

                p.x += p.vx;
                p.y += p.vy;

                p.onGround = false;
                this.entities.filter(e => e.type === 'platform').forEach(platform => {
                    if (this.collision(p, platform)) {
                        const overlapX = Math.min(p.x + p.width - platform.x, platform.x + platform.w - p.x);
                        const overlapY = Math.min(p.y + p.height - platform.y, platform.y + platform.h - p.y);

                        if (overlapY < overlapX) {
                            if (p.vy > 0 && p.y < platform.y) {
                                p.y = platform.y - p.height;
                                p.vy = 0;
                                p.onGround = true;
                            } else if (p.vy < 0 && p.y > platform.y) {
                                p.y = platform.y + platform.h;
                                p.vy = 0;
                            }
                        } else {
                            if (p.x < platform.x) {
                                p.x = platform.x - p.width;
                            } else {
                                p.x = platform.x + platform.w;
                            }
                            p.vx *= 0.3;
                        }
                    }
                });

                if (p.x < 0) {
                    p.x = 0;
                    p.vx = 0;
                }
                
                // FIX MOBILE: Migliore gestione larghezza mondo
                const effectiveWorldWidth = window.innerWidth <= 480 ? this.worldWidth * 0.75 : this.worldWidth;
                if (p.x + p.width > effectiveWorldWidth) {
                    p.x = effectiveWorldWidth - p.width;
                    p.vx = 0;
                }

                if (p.y > 600) {
                    this.playerDie();
                }
            }

            updateEnemies(deltaTime) {
                const platforms = this.entities.filter(e => e.type === 'platform');
                
                this.entities.filter(e => e.type === 'enemy').forEach((enemy) => {
                    enemy.vy += this.gravity;
                    if (enemy.vy > 10) enemy.vy = 10;
                    
                    if (enemy.platformBound && enemy.currentPlatform) {
                        const platform = enemy.currentPlatform;
                        
                        const nextX = enemy.x + enemy.vx * 2;
                        const wouldFallOff = (nextX <= platform.x) || (nextX + enemy.w >= platform.x + platform.w);
                        
                        const atRangeLimit = Math.abs(enemy.x - enemy.startX) >= enemy.range;
                        
                        if (wouldFallOff || atRangeLimit) {
                            enemy.vx *= -1;
                        }
                        
                        enemy.x = Math.max(platform.x, Math.min(platform.x + platform.w - enemy.w, enemy.x + enemy.vx));
                        enemy.y = platform.y - enemy.h;
                        enemy.vy = 0;
                        enemy.onGround = true;
                    } else {
                        enemy.x += enemy.vx;
                        enemy.y += enemy.vy;
                        
                        enemy.onGround = false;
                        platforms.forEach(platform => {
                            if (this.collision(enemy, platform)) {
                                if (enemy.vy > 0 && enemy.y < platform.y) {
                                    enemy.y = platform.y - enemy.h;
                                    enemy.vy = 0;
                                    enemy.onGround = true;
                                    if (enemy.platformBound) {
                                        enemy.currentPlatform = platform;
                                    }
                                }
                            }
                        });
                        
                        if (enemy.x < 0 || enemy.x + enemy.w > this.worldWidth) {
                            enemy.vx *= -1;
                        }
                        
                        if (enemy.y > 700) {
                            enemy.x = enemy.startX;
                            enemy.y = enemy.startX - 100;
                            enemy.vy = 0;
                            enemy.vx = Math.abs(enemy.vx) * (Math.random() > 0.5 ? 1 : -1);
                        }
                    }
                });
            }

            updateCamera(deltaTime) {
                // Fix camera per mobile
                const isMobile = window.innerWidth <= 768;
                const viewportWidth = isMobile ? window.innerWidth : 800;
                const effectiveWorldWidth = isMobile && window.innerWidth <= 480 ? this.worldWidth * 0.75 : this.worldWidth;
                
                const target = Math.max(0, Math.min(this.player.x - viewportWidth/2, effectiveWorldWidth - viewportWidth));
                this.camera.targetX = target;
                this.camera.x += (this.camera.targetX - this.camera.x) * 0.12;
            }

            updateBackground() {
                const starsLayer = document.getElementById('starsLayer');
                
                if (starsLayer) {
                    const transform = `translate3d(${-this.camera.x * 0.08}px, 0, 0)`;
                    starsLayer.style.transform = transform;
                }
            }

            checkCollisions() {
                const p = this.player;
                if (p.isDying) return; // Blocca collisioni durante morte

                this.entities.filter(e => e.type === 'collectible' && !e.collected).forEach((crystal) => {
                    const distance = Math.sqrt(
                        Math.pow(p.x + p.width/2 - (crystal.x + crystal.w/2), 2) + 
                        Math.pow(p.y + p.height/2 - (crystal.y + crystal.h/2), 2)
                    );
                    
                    if (distance < 30) {
                        crystal.collected = true;
                        this.score += 100;
                        this.updateHUD();
                        this.showCollectEffect(crystal.x, crystal.y);
                        this.audioManager.playSound('collect');
                    }
                });

                this.entities.filter(e => e.type === 'enemy').forEach((enemy) => {
                    if (this.collision(p, enemy)) {
                        this.playerDie();
                    }
                });

                const goalEntity = this.entities.find(e => e.type === 'goal');
                if (goalEntity && this.collision(p, goalEntity)) {
                    const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                    const total = this.entities.filter(e => e.type === 'collectible').length;
                    
                    if (collected === total) {
                        this.levelComplete();
                    } else {
                        const now = Date.now();
                        if (now - this.lastGoalMessage > this.goalMessageCooldown) {
                            this.showMessage(`Raccogli tutti i cristalli! (${collected}/${total})`);
                            this.lastGoalMessage = now;
                        }
                    }
                }
            }

            showCollectEffect(x, y) {
                const effect = document.createElement('div');
                effect.style.cssText = `
                    position: absolute;
                    left: ${x - this.camera.x}px;
                    top: ${y}px;
                    width: 30px;
                    height: 30px;
                    background: radial-gradient(circle, var(--neon-green), transparent);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    animation: collectEffect 0.5s ease-out forwards;
                `;
                
                document.body.appendChild(effect);
                setTimeout(() => effect.remove(), 500);
            }

            collision(a, b) {
                return a.x < b.x + b.w && 
                       a.x + a.width > b.x && 
                       a.y < b.y + b.h && 
                       a.y + a.height > b.y;
            }

            // NUOVA FUNZIONE: Gestione morte con animazione
            playerDie() {
                if (this.player.isDying) return; // Previeni multiple morti
                
                this.player.isDying = true;
                this.audioManager.playSound('hit'); // Nuovo suono drammatico
                
                // Aggiungi classe CSS per animazione
                const playerElements = document.querySelectorAll('.player');
                playerElements.forEach(el => el.classList.add('dying'));
                
                // Messaggio morte
                this.showMessage(`💥 Colpito! Energia: ${this.player.energy - 1}/3`);
                
                // Dopo animazione (800ms), procedi con respawn o game over
                setTimeout(() => {
                    this.player.energy--;
                    
                    if (this.player.energy <= 0) {
                        this.gameOver();
                    } else {
                        this.respawnPlayer();
                    }
                }, 800);
            }

            // NUOVA FUNZIONE: Respawn del giocatore
            respawnPlayer() {
                // Reset posizione e stato
                this.player.x = 50;
                this.player.y = 400;
                this.player.vx = 0;
                this.player.vy = 0;
                this.player.isDying = false;
                this.camera.x = 0;
                this.camera.targetX = 0;
                
                // Rimuovi classe animazione morte
                const playerElements = document.querySelectorAll('.player');
                playerElements.forEach(el => {
                    el.classList.remove('dying');
                    el.classList.add('respawning');
                });
                
                // Rimuovi classe respawn dopo 1 secondo
                setTimeout(() => {
                    const playerElements = document.querySelectorAll('.player');
                    playerElements.forEach(el => el.classList.remove('respawning'));
                }, 1000);
                
                this.updateHUD();
            }

            levelComplete() {
                this.running = false;
                this.score += 1000 + (this.player.energy * 300);
                this.audioManager.playSound('complete');
                this.story.showStory(this.currentLevel, 'outro');
            }

            processNextAction() {
                if (this.currentLevel === 3 || this.currentLevel === 5) {
                    this.showReward();
                } else if (this.currentLevel < this.maxLevels) {
                    this.nextLevel();
                } else {
                    this.showGameComplete();
                }
            }

            showReward() {
                const rewardCode = this.generateRewardCode();
                const discount = this.currentLevel === 3 ? '3%' : '5%';
                const minimum = this.currentLevel === 3 ? '150€' : '180€';

                document.getElementById('overlayTitle').textContent = '🎉 RICOMPENSA SBLOCCATA!';
                document.getElementById('overlayTitle').className = 'overlay-title success';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="background: linear-gradient(45deg, var(--neon-green), var(--neon-blue)); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; font-family: 'Orbitron', monospace; font-size: 1.2rem; font-weight: 700; position: relative;">
                        <div id="rewardCode" style="user-select: all; -webkit-user-select: all; -moz-user-select: all;">${rewardCode}</div>
                        <button onclick="copyRewardCode('${rewardCode}')" style="
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            color: white;
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            📋 Copia
                        </button>
                    </div>
                    <p style="font-size: 1.1rem; color: var(--neon-green); margin: 15px 0;">
                        <strong>✨ Sconto ${discount} su ordini sopra ${minimum} ✨</strong>
                    </p>
                    <p style="font-size: 0.9rem; opacity: 0.8;">
                        🔒 Salva questo codice! Verrà accettato nel nostro store.
                    </p>
                    <p style="margin-top: 20px; color: var(--neon-blue);">
                        Punteggio: <strong>${this.score.toLocaleString()}</strong>
                    </p>
                `;
                
                document.getElementById('overlayButton').textContent = this.currentLevel < this.maxLevels ? '➡️ CONTINUA' : '🏠 TORNA AL MENU';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    if (this.currentLevel < this.maxLevels) {
                        this.nextLevel();
                    } else {
                        this.showGameComplete();
                    }
                };
                
                this.showOverlay();
            }

            showGameComplete() {
                document.getElementById('overlayTitle').textContent = '👑 MISSIONE COMPLETATA!';
                document.getElementById('overlayTitle').className = 'overlay-title success';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <h2 style="color: var(--neon-green); font-size: 1.5rem; margin-bottom: 20px;">
                            🎉 HAI SALVATO TUTTE LE DIMENSIONI! 🎉
                        </h2>
                        
                        <div style="background: var(--glass); border-radius: 15px; padding: 25px; margin: 20px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                                <div><strong style="color: var(--neon-blue);">🏆 Esploratore:</strong><br>${this.player.name}</div>
                                <div><strong style="color: var(--neon-blue);">⏱️ Tempo:</strong><br>${this.formatTime(this.gameTime)}</div>
                                <div><strong style="color: var(--neon-blue);">💯 Punteggio:</strong><br>${this.score.toLocaleString()}</div>
                                <div><strong style="color: var(--neon-blue);">⚡ Energia finale:</strong><br>${this.player.energy}/3</div>
                            </div>
                        </div>
                        
                        <p style="font-size: 1rem; color: var(--neon-green); margin: 15px 0;">
                            🌌 Tutte le dimensioni digitali sono state ripristinate!<br>
                            🎮 Sei ufficialmente un Maestro Esploratore!
                        </p>
                    </div>
                `;
                
                document.getElementById('overlayButton').textContent = '🏠 TORNA AL MENU';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    this.showScreen('mainMenu');
                };
                
                this.showOverlay();
            }

            gameOver() {
                this.running = false;
                
                document.getElementById('overlayTitle').textContent = '💀 MISSIONE FALLITA';
                document.getElementById('overlayTitle').className = 'overlay-title danger';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <p style="font-size: 1.1rem; color: var(--neon-orange); margin-bottom: 20px;">
                            ⚡ Le entità corrotte hanno vinto... per ora ⚡
                        </p>
                        
                        <div style="background: var(--glass); border-radius: 10px; padding: 20px; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>🎯 Livello raggiunto:</span>
                                <span style="color: var(--neon-blue);">${this.currentLevel}/${this.maxLevels}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>💯 Punteggio finale:</span>
                                <span style="color: var(--neon-green);">${this.score.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>⏱️ Tempo sopravvissuto:</span>
                                <span style="color: var(--neon-purple);">${this.formatTime(this.gameTime)}</span>
                            </div>
                        </div>
                        
                        <p style="font-size: 1rem; margin: 15px 0; color: var(--neon-blue);">
                            💪 Non mollare! Le dimensioni hanno ancora bisogno di te!
                        </p>
                    </div>
                `;
                
                document.getElementById('overlayButton').textContent = '🔄 RIPROVA';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    this.currentLevel = 1;
                    this.score = 0;
                    this.player.energy = 3;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.story.showStory(1, 'intro');
                };
                
                this.showOverlay();
            }

            nextLevel() {
                this.currentLevel++;
                if (this.currentLevel <= this.maxLevels) {
                    this.story.showStory(this.currentLevel, 'intro');
                }
            }

            confirmExit() {
                if (confirm('Vuoi davvero tornare al menu? Il progresso andrà perso.')) {
                    this.running = false;
                    this.isPaused = false;
                    this.state = 'menu';
                    this.showScreen('mainMenu');
                }
            }

            generateRewardCode() {
                const prefix = this.currentLevel === 3 ? 'RETRO3' : 'RETRO5';
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.random().toString(36).substr(2, 4).toUpperCase();
                const playerHash = this.player.name.slice(0, 2).toUpperCase();
                return `${prefix}-${playerHash}${timestamp.slice(-3)}-${random}`;
            }

            render() {
                const world = document.getElementById('world');
                if (!world) return;
                
                world.style.transform = `translate3d(${-this.camera.x}px, 0, 0)`;
                
                const fragment = document.createDocumentFragment();
                
                const playerEl = document.createElement('div');
                playerEl.className = 'player';
                playerEl.style.cssText = `
                    left: ${this.player.x}px;
                    top: ${this.player.y}px;
                `;
                
                if (Math.abs(this.player.vx) > 1 && !this.player.isDying) {
                    playerEl.classList.add('moving');
                }
                
                // Mantieni classe dying se necessario
                if (this.player.isDying) {
                    playerEl.classList.add('dying');
                }
                
                fragment.appendChild(playerEl);
                
                const cameraLeft = this.camera.x - 100;
                const cameraRight = this.camera.x + 900;
                
                this.visibleEntities = this.entities.filter(entity => {
                    if (entity.type === 'collectible' && entity.collected) return false;
                    return entity.x + entity.w >= cameraLeft && entity.x <= cameraRight;
                });
                
                this.visibleEntities.forEach(entity => {
                    const el = document.createElement('div');
                    el.className = entity.type;
                    
                    if (entity.id) {
                        el.setAttribute('data-enemy-id', entity.id);
                    }
                    
                    el.style.cssText = `
                        left: ${entity.x}px;
                        top: ${entity.y}px;
                        width: ${entity.w}px;
                        height: ${entity.h}px;
                    `;
                    
                    if (entity.type === 'enemy' && entity.w > 30) {
                        el.style.background = 'linear-gradient(45deg, var(--neon-purple), var(--neon-orange))';
                        el.style.border = '2px solid var(--neon-purple)';
                        el.style.boxShadow = '0 0 30px var(--neon-purple)';
                    }
                    
                    fragment.appendChild(el);
                });
                
                world.innerHTML = '';
                world.appendChild(fragment);
            }

            updateHUD() {
                const updates = {
                    'hud-name': this.player.name,
                    'hud-level': this.currentLevel,
                    'hud-score': this.score.toLocaleString()
                };
                
                Object.entries(updates).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && el.textContent !== String(value)) {
                        el.textContent = value;
                    }
                });
                
                this.updateEnergyDisplay();
                
                const hudCrystals = document.getElementById('hud-crystals');
                if (hudCrystals) {
                    const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                    const total = this.entities.filter(e => e.type === 'collectible').length;
                    const crystalText = `${collected}/${total}`;
                    if (hudCrystals.textContent !== crystalText) {
                        hudCrystals.textContent = crystalText;
                    }
                }
            }

            updateEnergyDisplay() {
                const energyBar = document.getElementById('energy-bar');
                if (!energyBar) return;
                
                const orbs = energyBar.querySelectorAll('.energy-orb');
                orbs.forEach((orb, index) => {
                    if (index < this.player.energy) {
                        orb.classList.remove('empty');
                    } else {
                        orb.classList.add('empty');
                    }
                });
            }

            updateTimer() {
                const time = this.formatTime(this.gameTime);
                const hudTime = document.getElementById('hud-time');
                if (hudTime && hudTime.textContent !== time) {
                    hudTime.textContent = time;
                }
            }

            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            showScreen(screenId) {
                if (screenId === 'mainMenu') {
                    document.body.classList.remove('game-active');
                }
                
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                setTimeout(() => {
                    const screen = document.getElementById(screenId);
                    if (screen) screen.classList.add('active');
                }, 100);
                this.state = screenId === 'mainMenu' ? 'menu' : this.state;
                
                if (screenId === 'mainMenu') {
                    this.audioManager.currentMusicLevel = 0;
                    this.audioManager.stopMusic();
                    setTimeout(() => this.audioManager.startBackgroundMusic(), 500);
                }
            }

            showOverlay() {
                const overlay = document.getElementById('gameOverlay');
                if (overlay) overlay.classList.add('active');
            }

            hideOverlay() {
                const overlay = document.getElementById('gameOverlay');
                if (overlay) overlay.classList.remove('active');
            }

            showMessage(text) {
                const message = document.createElement('div');
                message.className = 'enhanced-message';
                message.textContent = text;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.style.animation = 'enhancedMessageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.remove();
                        }
                    }, 400);
                }, 3000);
            }
        }

        // Game Manager - Central hub for all game interactions
        class GameManager {
            constructor() {
                this.game = null;
                this.init();
            }

            init() {
                this.game = new Game();
                
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', e => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.game && this.game.running) {
                        this.game.pauseGame();
                        this.game.showMessage('🔄 Gioco automaticamente in pausa');
                    }
                });
                
                window.addEventListener('beforeunload', e => {
                    if (this.game && this.game.running && this.game.state === 'playing') {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
                
                console.log('🎮 RetroAvia - The Dark Chronicles caricato con successo!');
            }

            startGame() {
                const nameInput = document.getElementById('playerName');
                if (!nameInput) return;
                
                const name = nameInput.value.trim();
                if (!name || name.length < 2) {
                    this.showNotification('Inserisci un nome di almeno 2 caratteri!');
                    return;
                }
                if (name.length > 12) {
                    this.showNotification('Il nome deve essere massimo 12 caratteri!');
                    return;
                }
                
                if (this.game) {
                    this.game.audioManager.playSound('button');
                    this.game.start(name);
                }
            }

            handleStoryAction() {
                if (this.game && this.game.story) {
                    this.game.audioManager.playSound('button');
                    this.game.story.hideStory();
                    
                    const storyTitle = document.getElementById('storyTitle').textContent;
                    if (storyTitle.includes('INIZIA MISSIONE') || storyTitle.includes('IL RISVEGLIO') || 
                        storyTitle.includes('LE ISOLE FLUTTUANTI') || storyTitle.includes('IL GUANTO DI SFIDA') || 
                        storyTitle.includes('PRECISIONE ASSOLUTA') || storyTitle.includes('LO SCONTRO FINALE')) {
                        this.game.startLevel();
                    } else {
                        this.game.processNextAction();
                    }
                }
            }

            pauseGame() {
                if (this.game) {
                    this.game.pauseGame();
                }
            }

            resumeGame() {
                if (this.game) {
                    this.game.resumeGame();
                }
            }

            restartLevel() {
                if (this.game) {
                    this.game.restartLevel();
                }
            }

            goHomeFromPause() {
                if (this.game) {
                    this.game.goHomeFromPause();
                }
            }

            showMenu() {
                if (this.game) {
                    this.game.running = false;
                    this.game.isPaused = false;
                    this.game.state = 'menu';
                    this.game.audioManager.playSound('button');
                    this.game.showScreen('mainMenu');
                }
            }

            goHome() {
                if (this.game && this.game.state === 'playing') {
                    this.game.confirmExit();
                } else if (this.game) {
                    this.showMenu();
                }
            }

            toggleAudio() {
                if (this.game && this.game.audioManager) {
                    this.game.audioManager.toggle();
                }
            }

            toggleQuality() {
                if (this.game && this.game.renderEngine) {
                    const currentMode = this.game.renderEngine.performanceMode;
                    const newMode = currentMode === 'high' ? 'low' : 'high';
                    this.game.renderEngine.setQualityMode(newMode);
                    
                    const btn = document.getElementById('qualityToggle');
                    if (btn) {
                        btn.className = newMode === 'low' ? 'quality-btn low-quality' : 'quality-btn';
                        btn.title = newMode === 'low' ? 'Qualità: Bassa' : 'Qualità: Alta';
                    }
                    
                    this.showNotification(`Qualità: ${newMode === 'high' ? 'Alta' : 'Bassa'}`);
                }
            }

            nextAction() {
                const overlayButton = document.getElementById('overlayButton');
                if (overlayButton && overlayButton.onclick) {
                    overlayButton.onclick();
                }
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--neon-orange);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    font-family: 'Orbitron', monospace;
                    font-weight: 700;
                    z-index: 2000;
                    animation: slideDown 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }
        }

        // Global function definitions
        function startGame() {
            if (gameManager) {
                gameManager.startGame();
            }
        }

        function handleStoryAction() {
            if (gameManager) {
                gameManager.handleStoryAction();
            }
        }

        function pauseGame() {
            if (gameManager) {
                gameManager.pauseGame();
            }
        }

        function resumeGame() {
            if (gameManager) {
                gameManager.resumeGame();
            }
        }

        function restartGame() {
            if (gameManager) {
                gameManager.restartLevel();
            }
        }

        function goHomeFromPause() {
            if (gameManager) {
                gameManager.goHomeFromPause();
            }
        }

        function goHome() {
            if (gameManager) {
                gameManager.goHome();
            }
        }

        function toggleAudio() {
            if (gameManager) {
                gameManager.toggleAudio();
            }
        }

        function toggleQuality() {
            if (gameManager) {
                gameManager.toggleQuality();
            }
        }

        function nextAction() {
            if (gameManager) {
                gameManager.nextAction();
            }
        }

        // NUOVA FUNZIONE: Copia codice sconto
        function copyRewardCode(code) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showCopyConfirmation('✅ Codice copiato negli appunti!');
                }).catch(() => {
                    fallbackCopyText(code);
                });
            } else {
                fallbackCopyText(code);
            }
        }

        // Fallback per browser più vecchi
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopyConfirmation('✅ Codice copiato negli appunti!');
            } catch (err) {
                showCopyConfirmation('❌ Errore nella copia. Seleziona e copia manualmente.');
            }
            
            document.body.removeChild(textArea);
        }

        // Mostra conferma copia
        function showCopyConfirmation(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-family: 'Orbitron', monospace;
                font-weight: 700;
                z-index: 10000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 2000);
        }

        // Initialize game
        function initializeGame() {
            try {
                if (!gameManager) {
                    gameManager = new GameManager();
                    window.gameManager = gameManager;
                    console.log('🎮 Game Manager initialized successfully');
                }
                return true;
            } catch (error) {
                console.error('Game initialization error:', error);
                return false;
            }
        }

        // Initialize immediately when script loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeGame();
            
            document.addEventListener('click', (e) => {
                if (e.target.matches('.btn, .neo-btn, .audio-btn, .launch-button') || e.target.closest('.neo-btn')) {
                    if (gameManager && gameManager.game && gameManager.game.audioManager) {
                        gameManager.game.audioManager.playSound('button');
                    }
                }
            });
            
            // Setup responsive zoom controls visibility
            function updateZoomControlsVisibility() {
                const isMobile = window.innerWidth <= 768;
                const zoomControls = document.querySelector('.mobile-zoom-controls');
                if (zoomControls) {
                    zoomControls.style.display = isMobile ? 'flex' : 'none';
                }
            }
            
            window.addEventListener('resize', updateZoomControlsVisibility);
            updateZoomControlsVisibility();
        });

        // Fallback initialization
        window.addEventListener('load', () => {
            if (!gameManager) {
                initializeGame();
            }
        });

        // Initialize immediately for safety
        setTimeout(() => {
            if (!gameManager) {
                initializeGame();
            }
        }, 100);
    </script>
</body>
</html>
